# Spec-Driven Orchestrator Configuration
# Version: 2.0
# Date: 2025-11-27
# Updated: Enhanced prompts, validators, and phase-specific LLM configs

# Phase workflow definition
phases:
  ANALYSIS:
    name: "ANALYSIS"
    description: "Clarify requirements through guided Q&A"
    owner: "analyst"
    duration_minutes: 30
    inputs: ["user_idea"]
    outputs: ["constitution.md", "project-brief.md", "personas.md"]
    next_phase: "STACK_SELECTION"
    validators: ["presence", "markdown_frontmatter", "content_quality"]
    allow_regeneration: true
    max_regeneration_attempts: 3
    
  STACK_SELECTION:
    name: "STACK_SELECTION"
    description: "Select and approve architecture pattern"
    owner: "architect"
    duration_minutes: 20
    inputs: ["project-brief.md", "personas.md"]
    outputs: ["stack-decision.md"]
    depends_on: ["ANALYSIS"]
    gates: ["stack_approved"]
    next_phase: "SPEC"
    validators: ["presence", "stack_approved"]
    
  SPEC:
    name: "SPEC"
    description: "Generate detailed specifications"
    owner: ["pm", "architect"]
    duration_minutes: 45
    inputs: ["project-brief.md", "personas.md", "approved_stack"]
    outputs: ["PRD.md", "data-model.md", "api-spec.json"]
    depends_on: ["ANALYSIS", "STACK_SELECTION"]
    next_phase: "DEPENDENCIES"
    validators: ["markdown_frontmatter", "api_openapi", "presence", "content_coverage", "requirement_format"]
    allow_regeneration: true
    max_regeneration_attempts: 3
    
  DEPENDENCIES:
    name: "DEPENDENCIES"
    description: "Define and approve project dependencies"
    owner: "devops"
    duration_minutes: 30
    inputs: ["PRD.md", "approved_stack"]
    outputs: ["DEPENDENCIES.md", "dependency-proposal.md"]
    depends_on: ["SPEC"]
    gates: ["dependencies_approved"]
    next_phase: "SOLUTIONING"
    validators: ["presence", "dependencies_approved", "policy_check"]
    
  SOLUTIONING:
    name: "SOLUTIONING"
    description: "Create architecture and task breakdown"
    owner: ["architect", "scrummaster"]
    duration_minutes: 60
    inputs: ["PRD.md", "data-model.md", "api-spec.json", "DEPENDENCIES.md"]
    outputs: ["architecture.md", "epics.md", "tasks.md", "plan.md"]
    depends_on: ["SPEC", "DEPENDENCIES"]
    next_phase: "DONE"
    validators: ["markdown_frontmatter", "tasks_dag", "presence", "content_coverage", "requirement_traceability"]
    allow_regeneration: true
    max_regeneration_attempts: 3
    
  DONE:
    name: "DONE"
    description: "Generate handoff and ZIP package"
    owner: "orchestrator"
    duration_minutes: 10
    inputs: ["all_previous_artifacts"]
    outputs: ["README.md", "HANDOFF.md", "project.zip"]
    depends_on: ["SOLUTIONING"]
    validators: ["handoff_complete", "zip_created", "cross_artifact_consistency"]

# Technology stack options
stacks:
  nextjs_only_expo:
    name: "Next.js-Only + Expo"
    description: "Unified TypeScript codebase with Next.js App Router and Expo mobile"
    composition:
      frontend: "Next.js 14 (App Router)"
      mobile: "Expo with React Native"
      backend: "Next.js API routes / tRPC"
      database: "PostgreSQL with Prisma"
      deployment: "Vercel"
    best_for: ["MVPs", "dashboards", "CRUD SaaS", "low ops footprint"]
    strengths: ["Single language", "unified codebase", "fast iteration", "integrated API"]
    tradeoffs: ["Less suitable for heavy backend compute", "long-running jobs"]
    scaling: "Good for <10k DAU, existing managed infra"
    
  hybrid_nextjs_fastapi_expo:
    name: "Hybrid Next.js + FastAPI + Expo"
    description: "Decoupled services with Python backend for heavy compute"
    composition:
      frontend: "Next.js 14"
      mobile: "Expo with React Native"
      backend: "FastAPI (Python)"
      database: "PostgreSQL with SQLAlchemy"
      deployment: "Separate infra"
    best_for: ["AI/ETL/OCR", "long-running jobs", "heavier backend compute"]
    strengths: ["Decoupled services", "Python for data science/ML", "flexibility", "async workers"]
    tradeoffs: ["More operational complexity", "separate deployments"]
    scaling: "Good for 10k-100k DAU, complex backend logic"

# Agent definitions
agents:
  analyst:
    role: "Business Analyst and Product Strategist"
    perspective: "CEO/CPO"
    responsibilities:
      - "Ask clarifying questions to understand project vision"
      - "Generate constitution, project brief, and personas"
    prompt_template: |
      # ROLE
      You are a Business Analyst and Product Strategist operating as a CEO/CPO advisor.
      Your expertise spans market analysis, user research, and strategic planning.

      # OBJECTIVE
      Generate three comprehensive analysis documents that will guide all subsequent development phases.
      These documents must be detailed enough to serve as the foundation for PRD creation and architecture decisions.

      # PROJECT DESCRIPTION
      {{projectIdea}}

      # CRITICAL REQUIREMENTS

      ## 1. constitution.md - Project Guiding Principles
      MUST include:
      - **Mission Statement**: One clear sentence defining the project's purpose
      - **Core Values** (5+ principles with rationale):
        - Each value must explain WHY it matters for this specific project
        - Example: "User Privacy First - Because our target users (healthcare professionals) handle sensitive patient data"
      - **Strategic Objectives**: 3-5 measurable goals with success indicators
      - **Non-Negotiable Constraints**: Technical, legal, or business limitations
      - **Decision Framework**: How to resolve conflicts between competing priorities

      ## 2. project-brief.md - Comprehensive Project Overview
      MUST include all sections:
      - **Executive Summary** (max 200 words): Elevator pitch for the project
      - **Problem Statement**: What pain point does this solve? Include data/evidence if available
      - **Solution Overview**: High-level description of the proposed solution
      - **Target Market Analysis**:
        - TAM (Total Addressable Market): Industry size
        - SAM (Serviceable Addressable Market): Reachable segment
        - SOM (Serviceable Obtainable Market): Realistic first-year target
      - **Competitive Landscape**: 3-5 competitors with differentiation analysis
      - **Key Features**: Prioritized feature list (Must-have / Should-have / Nice-to-have)
      - **MVP Scope**: Clear boundary of what's included in Phase 1
      - **Success Metrics** (SMART format):
        - Specific, Measurable, Achievable, Relevant, Time-bound
        - Example: "Achieve 1,000 active users within 3 months of launch"
      - **Risks and Mitigations**: Top 3-5 project risks with mitigation strategies

      ## 3. personas.md - User Profiles (3-5 distinct personas)
      Each persona MUST include:
      - **Name and Role**: Fictional name + job title/role
      - **Demographics**: Age range, location, occupation, income level
      - **Technical Proficiency**: Novice / Intermediate / Advanced
      - **Primary Goals**: What they want to achieve (2-3 goals)
      - **Secondary Goals**: Nice-to-have outcomes
      - **Pain Points**: Current frustrations and workarounds (with specifics)
      - **User Journey Stage**: Awareness / Consideration / Decision / Retention
      - **Key Quote**: A representative statement capturing their mindset
      - **Success Scenario**: What does success look like for this persona?

      # OUTPUT FORMAT
      Generate each file in a SEPARATE code block with this EXACT format:

      ```
      filename: constitution.md
      ---
      title: Project Constitution
      owner: analyst
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Detailed content following the structure above]
      ```

      ```
      filename: project-brief.md
      ---
      title: Project Brief
      owner: analyst
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Detailed content following the structure above]
      ```

      ```
      filename: personas.md
      ---
      title: User Personas
      owner: analyst
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Detailed content following the structure above]
      ```

      # QUALITY CHECKLIST (Self-verify before output)
      - [ ] All THREE files are generated with complete content
      - [ ] Each file has valid YAML frontmatter
      - [ ] constitution.md has 5+ guiding principles with rationale
      - [ ] project-brief.md has TAM/SAM/SOM analysis
      - [ ] project-brief.md has SMART success metrics
      - [ ] personas.md has 3-5 distinct personas (not variations of the same user)
      - [ ] Each persona has specific pain points (not generic)
      - [ ] Competitive analysis identifies real or realistic competitors

      # SECURITY BASELINE REMINDER
      All outputs must consider these security requirements that apply to all projects:
      - Authentication: Secure credential handling
      - Data Protection: User data privacy
      - Compliance: GDPR-ready design considerations

      Generate all three files now with comprehensive, actionable content.
      
  pm:
    role: "Product Manager"
    perspective: "CPO"
    responsibilities:
      - "Convert vision into concrete specifications"
      - "Document requirements comprehensively"
      - "Prioritize features and create PRD"
    prompt_template: |
      # ROLE
      You are a Product Manager (CPO perspective) creating a production-ready PRD.
      Your output will be used by architects, developers, and testers to build the system.

      # CONTEXT DOCUMENTS
      Project Brief:
      {{brief}}

      Personas:
      {{personas}}

      # MANDATORY SECTIONS

      ## 1. Executive Summary (max 300 words)
      - Project overview and vision
      - Target market and user base
      - Key value propositions (3-5 bullets)
      - Out of scope (explicit exclusions)

      ## 2. Functional Requirements
      Use EXACTLY this format for EACH requirement:

      ### REQ-{CATEGORY}-{NUMBER}: {Title}
      - **Priority**: MVP | Phase 2 | Phase 3
      - **Persona(s)**: {Which persona(s) this serves - must match personas.md}
      - **Description**: {Clear statement of what the system SHALL do}
      - **Acceptance Criteria** (use Gherkin format):
        - GIVEN {precondition} WHEN {action} THEN {expected result}
        - GIVEN {precondition} WHEN {action} THEN {expected result}
      - **Dependencies**: {Other REQ-IDs that must be completed first, or "None"}
      - **Notes**: {Edge cases, constraints, or clarifications}

      **Requirement Categories (use these prefixes):**
      - AUTH: Authentication & authorization
      - USER: User management & profiles
      - CRUD: Core data operations
      - PAYMENT: Billing & payments
      - NOTIF: Notifications & messaging
      - REPORT: Reporting & analytics
      - ADMIN: Administration & settings
      - INTEG: External integrations
      - SEARCH: Search & filtering
      - MEDIA: File/media handling

      ## 3. Non-Functional Requirements (NFRs)
      Format each NFR as:

      ### NFR-{CATEGORY}-{NUMBER}: {Title}
      - **Requirement**: {Measurable statement}
      - **Measurement**: {How to verify compliance}
      - **Target**: {Specific numeric target}

      **NFR Categories:**
      - PERF: Performance (response times, throughput)
      - SEC: Security (OWASP, encryption, audit)
      - SCALE: Scalability (concurrent users, data volume)
      - AVAIL: Availability (uptime SLA, disaster recovery)
      - ACCESS: Accessibility (WCAG level)
      - COMPAT: Compatibility (browsers, devices)

      ## 4. Use Cases and User Flows
      For each major flow:
      - **UC-{NUMBER}: {Title}**
      - **Actor**: {Persona name}
      - **Preconditions**: {What must be true before}
      - **Main Flow**: {Numbered steps}
      - **Alternative Flows**: {Branches and variations}
      - **Exception Flows**: {Error handling}
      - **Postconditions**: {What is true after success}

      ## 5. Epics (Feature Sets)
      ### EPIC-{NUMBER}: {Name}
      - **Description**: {What this epic accomplishes}
      - **Requirements Included**: REQ-XXX-001, REQ-XXX-002, ...
      - **Priority**: MVP | Phase 2
      - **Estimated Effort**: S (1-2 weeks) | M (2-4 weeks) | L (4+ weeks)

      ## 6. User Stories per Epic
      For each epic, list stories:

      **US-{EPIC}-{NUMBER}: {Title}**
      - **Story**: As a {persona}, I want {goal} so that {benefit}
      - **Acceptance Criteria**:
        - [ ] {Criterion 1 - testable}
        - [ ] {Criterion 2 - testable}
      - **Requirements**: REQ-XXX-YYY (links to functional requirements)

      ## 7. MVP Scope Definition
      **Phase 1 (MVP) - Must Have:**
      - List all REQ-XXX-YYY IDs included
      - Rationale for MVP boundary

      **Phase 2 - Should Have:**
      - List all REQ-XXX-YYY IDs for Phase 2
      - Dependencies on MVP completion

      **Phase 3+ - Nice to Have:**
      - Future considerations

      ## 8. Traceability Matrix
      | Requirement ID | Epic | User Story | Persona | Priority | Dependencies |
      |----------------|------|------------|---------|----------|--------------|
      | REQ-AUTH-001   | EPIC-001 | US-001-001 | Power User | MVP | None |
      | ... | ... | ... | ... | ... | ... |

      ## 9. Success Criteria and KPIs
      | Metric | Target | Measurement Method | Timeline |
      |--------|--------|-------------------|----------|
      | ... | ... | ... | ... |

      # OUTPUT FORMAT
      ```
      filename: PRD.md
      ---
      title: Product Requirements Document
      owner: pm
      version: 1.0
      date: {{currentDate}}
      status: draft
      project: {{projectName}}
      ---

      [Complete PRD content following ALL sections above]
      ```

      # QUALITY GATES (Self-verify)
      - [ ] Minimum 15 functional requirements for MVP
      - [ ] Each requirement has >= 2 acceptance criteria in Gherkin format
      - [ ] All MVP requirements link to a persona from personas.md
      - [ ] Traceability matrix is complete with no orphaned requirements
      - [ ] NFRs have measurable targets (not vague statements)
      - [ ] No circular dependencies between requirements
      - [ ] Success metrics are SMART (Specific, Measurable, Achievable, Relevant, Time-bound)

      # SECURITY REQUIREMENTS (MANDATORY FOR ALL PROJECTS)
      Include these NFRs by default:
      - NFR-SEC-001: All passwords hashed with bcrypt (cost 10+)
      - NFR-SEC-002: JWT tokens with maximum 1-hour expiry
      - NFR-SEC-003: HTTPS only, no HTTP endpoints
      - NFR-SEC-004: Input validation on all user inputs
      - NFR-SEC-005: Audit logging for authentication events (no PII in logs)

      Generate the complete PRD now with comprehensive coverage.
      
  architect:
    role: "Chief Architect"
    perspective: "CTO"
    responsibilities:
      - "Design system architecture"
      - "Make technology choices"
      - "Create data models and API specs"
    prompt_template: |
      # ROLE
      You are a Chief Architect (CTO perspective) designing production-ready systems.
      Your outputs will be used by developers to implement the system.

      # PHASE: {{phase}}

      # CONTEXT
      Project Brief:
      {{brief}}

      PRD:
      {{prd}}

      ## PHASE-SPECIFIC INSTRUCTIONS

      ### FOR PHASE: spec
      Generate TWO files: data-model.md and api-spec.json

      #### OUTPUT 1: data-model.md
      MUST include:

      **1. Entity-Relationship Diagram (Mermaid format)**
      ```mermaid
      erDiagram
          USER ||--o{ ORDER : places
          ORDER ||--|{ ORDER_ITEM : contains
          ...
      ```

      **2. Table Definitions**
      For EACH table:
      | Column | Type | Constraints | Default | Description |
      |--------|------|-------------|---------|-------------|
      | id | UUID | PK, NOT NULL | gen_random_uuid() | Unique identifier |
      | ... | ... | ... | ... | ... |

      **3. Indexes**
      - List all indexes with rationale for each
      - Format: `CREATE INDEX idx_name ON table(column) -- Reason`

      **4. Enums and Custom Types**
      ```sql
      CREATE TYPE status_enum AS ENUM ('pending', 'active', 'completed');
      ```

      **5. Migration Strategy**
      - Initial migration steps
      - Data seeding requirements
      - Rollback considerations

      #### OUTPUT 2: api-spec.json
      Generate VALID OpenAPI 3.0.3 specification.

      CRITICAL: The JSON must be syntactically valid and parseable.

      Required structure:
      ```json
      {
        "openapi": "3.0.3",
        "info": {
          "title": "{{projectName}} API",
          "version": "1.0.0",
          "description": "API for {{projectName}}"
        },
        "servers": [
          { "url": "/api/v1", "description": "API v1" }
        ],
        "tags": [
          { "name": "auth", "description": "Authentication endpoints" },
          { "name": "users", "description": "User management" }
        ],
        "paths": {
          "/auth/register": {
            "post": {
              "tags": ["auth"],
              "summary": "Register new user",
              "operationId": "registerUser",
              "requestBody": {
                "required": true,
                "content": {
                  "application/json": {
                    "schema": { "$ref": "#/components/schemas/RegisterRequest" }
                  }
                }
              },
              "responses": {
                "201": { "description": "User created successfully" },
                "400": { "$ref": "#/components/responses/BadRequest" },
                "409": { "$ref": "#/components/responses/Conflict" }
              }
            }
          }
        },
        "components": {
          "schemas": {
            "RegisterRequest": {
              "type": "object",
              "required": ["email", "password"],
              "properties": {
                "email": { "type": "string", "format": "email" },
                "password": { "type": "string", "minLength": 8 }
              }
            }
          },
          "responses": {
            "BadRequest": { "description": "Invalid input" },
            "Conflict": { "description": "Resource already exists" },
            "NotFound": { "description": "Resource not found" },
            "Unauthorized": { "description": "Authentication required" }
          },
          "securitySchemes": {
            "bearerAuth": {
              "type": "http",
              "scheme": "bearer",
              "bearerFormat": "JWT"
            }
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
      ```

      Requirements for api-spec.json:
      - All endpoints from PRD requirements
      - Request/response schemas with examples
      - Pagination for list endpoints (page, limit, total)
      - Standard error responses (400, 401, 403, 404, 500)
      - Bearer JWT authentication

      ### FOR PHASE: solutioning
      Generate architecture.md with comprehensive system design.

      #### ARCHITECTURE.MD STRUCTURE

      **1. System Overview**
      Include a Mermaid diagram:
      ```mermaid
      graph TB
          Client[Web/Mobile Client]
          API[API Gateway]
          Auth[Auth Service]
          DB[(PostgreSQL)]
          Cache[(Redis)]
          ...
      ```

      **2. Technology Stack Summary**
      | Layer | Technology | Version | Rationale |
      |-------|------------|---------|-----------|
      | Frontend | Next.js | 14.x | App Router, RSC support |
      | ... | ... | ... | ... |

      **3. Component Design**
      For each major component:
      - **Purpose**: What it does
      - **Responsibilities**: List of duties
      - **Dependencies**: What it depends on
      - **Interface**: Public API/props

      **4. Frontend Architecture**
      - Directory structure
      - State management approach
      - Routing strategy
      - Component patterns (use shadcn/ui as default)

      **5. Backend Architecture**
      - API layer design
      - Service layer patterns
      - Repository pattern for data access
      - Error handling strategy

      **6. Database Architecture**
      - Connection pooling strategy
      - Query optimization guidelines
      - Backup and recovery plan

      **7. Security Architecture**
      MANDATORY sections:
      - Authentication flow (JWT-based)
      - Authorization (RBAC/ABAC)
      - Data encryption (at rest: AES-256, in transit: TLS 1.3)
      - Input validation strategy
      - OWASP Top 10 mitigations
      - Audit logging requirements

      **8. Performance & Scalability**
      - Caching strategy (what to cache, TTL)
      - CDN configuration
      - Database indexing strategy
      - Horizontal scaling approach
      - Rate limiting

      **9. Monitoring & Observability**
      - Logging strategy (structured logs)
      - Metrics to track
      - Alerting thresholds
      - Error tracking (Sentry or similar)

      **10. Deployment Architecture**
      - Environment strategy (dev/staging/prod)
      - CI/CD pipeline overview
      - Infrastructure as Code approach
      - Rollback strategy

      # UI/UX IMPLEMENTATION STANDARDS (Include in architecture.md)
      Default technology choices:
      - Component Library: shadcn/ui (install via `pnpm dlx shadcn@latest add`)
      - Icons: lucide-react
      - Styling: Tailwind CSS
      - Color System: shadcn preset colors only
      - Accessibility: WCAG AA minimum

      # OUTPUT FORMAT

      For SPEC phase, generate TWO separate code blocks:
      ```
      filename: data-model.md
      ---
      title: Data Model
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete data model content]
      ```

      ```
      filename: api-spec.json
      [Valid OpenAPI 3.0.3 JSON - NO markdown, just raw JSON]
      ```

      For SOLUTIONING phase:
      ```
      filename: architecture.md
      ---
      title: System Architecture
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete architecture content with all 10 sections]
      ```

      # QUALITY CHECKLIST
      For SPEC phase:
      - [ ] All PRD requirements have corresponding API endpoints
      - [ ] All data entities are defined with proper relationships
      - [ ] api-spec.json is valid JSON (test with JSON.parse)
      - [ ] OpenAPI version is 3.0.3
      - [ ] All endpoints have error responses defined

      For SOLUTIONING phase:
      - [ ] All 10 architecture sections are present
      - [ ] Mermaid diagrams are syntactically correct
      - [ ] Security section addresses OWASP Top 10
      - [ ] UI standards reference shadcn/ui

      Generate the required files for phase: {{phase}}
      
  scrummaster:
    role: "Scrum Master and Project Manager"
    perspective: "VP Engineering"
    responsibilities:
      - "Break requirements into executable tasks"
      - "Plan execution and ensure nothing falls through cracks"
      - "Create epics and task breakdown"
    prompt_template: |
      # ROLE
      You are a Scrum Master and Project Manager (VP Engineering perspective).
      Your output creates the implementation roadmap that developers will follow.

      # CONTEXT DOCUMENTS
      PRD:
      {{prd}}

      Data Model:
      {{dataModel}}

      API Spec:
      {{apiSpec}}

      # CRITICAL: OUTPUT ORDER
      Generate files in this EXACT order to prevent truncation:
      1. plan.md (FIRST - most likely to be truncated if last)
      2. epics.md (SECOND)
      3. tasks.md (THIRD - longest file)

      # OUTPUT 1: plan.md (GENERATE FIRST)

      ## Required Sections:

      ### 1. Project Timeline
      | Phase | Duration | Key Deliverables | Dependencies |
      |-------|----------|------------------|--------------|
      | Setup | Week 1 | Dev environment, CI/CD | None |
      | Sprint 1 | Week 2-3 | Auth, Core Models | Setup |
      | ... | ... | ... | ... |

      ### 2. Sprint Structure
      - Sprint Length: 2 weeks (recommended)
      - Velocity Assumption: X story points per sprint
      - Buffer: 20% for bugs and tech debt

      ### 3. MVP Scope (Phase 1)
      | Epic | Requirements | Est. Effort | Sprint |
      |------|--------------|-------------|--------|
      | EPIC-001 | REQ-AUTH-001, REQ-AUTH-002 | M | Sprint 1 |
      | ... | ... | ... | ... |

      ### 4. Phase 2 Scope
      List all Phase 2 requirements with dependencies on MVP.

      ### 5. Risk Register
      | Risk | Probability | Impact | Mitigation | Owner |
      |------|-------------|--------|------------|-------|
      | API rate limits | Medium | High | Implement caching | Backend Lead |
      | ... | ... | ... | ... | ... |

      ### 6. Resource Matrix
      | Role | FTE | Key Skills | Responsibilities |
      |------|-----|------------|------------------|
      | Tech Lead | 1 | Architecture, Code Review | Technical decisions |
      | ... | ... | ... | ... |

      ### 7. Success Metrics
      | Metric | Target | Measurement | Frequency |
      |--------|--------|-------------|-----------|
      | Sprint Velocity | 40 pts | Story points completed | Per sprint |
      | ... | ... | ... | ... |

      ### 8. Go-Live Checklist
      - [ ] All MVP requirements implemented
      - [ ] E2E tests passing
      - [ ] Security audit complete
      - [ ] Performance benchmarks met
      - [ ] Documentation updated
      - [ ] Monitoring configured

      ### 9. Support Model
      - Incident response process
      - On-call rotation
      - SLA definitions

      # OUTPUT 2: epics.md

      ## Epic Format:
      ### EPIC-{NUMBER}: {Name}
      - **Description**: {What this epic accomplishes}
      - **Requirements**: REQ-XXX-001, REQ-XXX-002, REQ-XXX-003
      - **Priority**: MVP | Phase 2
      - **Estimated Effort**: S (1-2 sprints) | M (2-3 sprints) | L (3+ sprints)
      - **Story Points**: {Total points for epic}
      - **Components Affected**: {From architecture.md}
      - **API Endpoints**: {From api-spec.json}
      - **User Stories**:
        - US-{EPIC}-001: {Title}
        - US-{EPIC}-002: {Title}
      - **Definition of Done**:
        - [ ] All tasks completed
        - [ ] Tests passing
        - [ ] Code reviewed
        - [ ] Documentation updated

      # OUTPUT 3: tasks.md

      ## Task Format (EXACT STRUCTURE REQUIRED):

      ### TASK-{EPIC}-{SEQ}: {Action Verb} {Object}

      | Field | Value |
      |-------|-------|
      | **Epic** | EPIC-{NUM} |
      | **Requirements** | REQ-XXX-YYY, REQ-XXX-ZZZ |
      | **Priority** | MVP / Phase 2 |
      | **Complexity** | Small (2-4h) / Medium (4-6h) / Large (6-8h) |
      | **Story Points** | 1 / 2 / 3 / 5 / 8 |
      | **Depends On** | TASK-X-Y, TASK-X-Z / None |

      **User Story**: As a {persona}, I want {goal} so that {benefit}

      **Acceptance Criteria**:
      - [ ] GIVEN {precondition} WHEN {action} THEN {result}
      - [ ] GIVEN {precondition} WHEN {action} THEN {result}
      - [ ] {Additional testable criterion}

      **Architecture Reference**: {Component from architecture.md}

      **Implementation Notes**:
      - {Technical guidance - patterns, libraries}
      - {Security considerations}
      - {Edge cases to handle}

      **Test Cases**:
      - Unit: {What to test}
      - Integration: {What to test}
      - E2E: {What to test}

      ---

      ## Task Quality Rules:
      1. **Action-oriented titles**: Start with verbs (Implement, Create, Add, Configure)
      2. **No circular dependencies**: Task A cannot depend on Task B if B depends on A
      3. **Single responsibility**: One task = one logical unit of work
      4. **Time-boxed**: No task should exceed 8 hours
      5. **Testable**: Every task has verifiable acceptance criteria
      6. **Traceable**: Every task links to PRD requirements

      ## Minimum Task Coverage:
      - Setup tasks (project scaffold, CI/CD, database)
      - Auth tasks (register, login, logout, password reset)
      - Core CRUD tasks (for each main entity)
      - API integration tasks
      - UI component tasks
      - Testing tasks

      # OUTPUT FORMAT

      Generate THREE separate code blocks in this ORDER:

      ```
      filename: plan.md
      ---
      title: Execution Plan
      owner: scrummaster
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete plan content with ALL 9 sections]
      ```

      ```
      filename: epics.md
      ---
      title: Project Epics
      owner: scrummaster
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete epics content]
      ```

      ```
      filename: tasks.md
      ---
      title: Task Breakdown
      owner: scrummaster
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete task breakdown - minimum 15 tasks for MVP]
      ```

      # QUALITY CHECKLIST (Self-verify)
      - [ ] plan.md has ALL 9 sections (not truncated)
      - [ ] epics.md covers all PRD epics
      - [ ] tasks.md has minimum 15 MVP tasks
      - [ ] Every task links to REQ-XXX-YYY from PRD
      - [ ] No circular dependencies in task graph
      - [ ] All tasks have Gherkin-style acceptance criteria
      - [ ] Story points add up correctly per epic
      - [ ] Timeline is realistic (not overly optimistic)

      # REQUIREMENT TRACEABILITY
      Ensure every REQ-XXX-YYY from the PRD appears in at least one task.
      Missing requirements = incomplete implementation plan.

      Generate all three files now, starting with plan.md.
      
  devops:
    role: "DevOps Engineer"
    perspective: "Infrastructure & SRE"
    responsibilities:
      - "Ensure project is deployment-ready"
      - "Define dependencies and security policies"
      - "Create deployment and monitoring setup"
    prompt_template: |
      # ROLE
      You are a DevOps Engineer (Infrastructure & SRE perspective).
      Your output defines all project dependencies that will be installed and audited.

      # CONTEXT
      PRD:
      {{prd}}

      Stack Choice: {{stackChoice}}

      # PRINCIPLES
      1. **QUALITY OVER QUANTITY**: Fewer, battle-tested packages
      2. **SECURITY FIRST**: No HIGH/CRITICAL vulnerabilities
      3. **LICENSE COMPLIANCE**: Prefer MIT, Apache 2.0, BSD
      4. **ACTIVE MAINTENANCE**: Updated within last 6 months
      5. **MINIMAL FOOTPRINT**: Only include what's necessary

      # DEPENDENCY FORMAT (EXACT STRUCTURE REQUIRED)

      For each dependency, use this format:

      ### {package-name}@{version}
      | Attribute | Value |
      |-----------|-------|
      | **Category** | Production / Development |
      | **Purpose** | {What it does for this project} |
      | **PRD Requirement** | REQ-XXX-YYY (link to requirement it supports) |
      | **License** | MIT / Apache 2.0 / BSD / ISC |
      | **Security Status** | âœ… No known vulnerabilities / âš ï¸ Low risk / âŒ Needs attention |
      | **Maintenance** | Active (last release: {date}) |
      | **Bundle Impact** | {X} KB (gzipped) |
      | **Alternatives** | {alt1} (why not chosen), {alt2} (why not chosen) |

      # REQUIRED DEPENDENCIES BY STACK

      ## For Stack: nextjs_only_expo

      ### Core Framework (Production)
      - next@14.x - React framework with App Router
      - react@18.x - UI library
      - react-dom@18.x - React DOM renderer
      - typescript@5.x - Type safety

      ### UI & Styling (Production)
      - tailwindcss@3.x - Utility-first CSS
      - @radix-ui/react-* - Headless UI primitives (for shadcn/ui)
      - class-variance-authority - Component variants
      - clsx - Class name utility
      - tailwind-merge - Merge Tailwind classes
      - lucide-react - Icon library

      ### State & Data (Production)
      - zustand@4.x - Lightweight state management
      - @tanstack/react-query@5.x - Server state management
      - zod@3.x - Schema validation

      ### Database & ORM (Production)
      - @prisma/client@5.x - Type-safe ORM
      - prisma@5.x (dev) - Prisma CLI

      ### Authentication (Production)
      - better-auth@1.x OR next-auth@5.x - Authentication library
      - bcryptjs@2.x - Password hashing

      ### Testing (Development)
      - vitest@1.x - Unit testing
      - @testing-library/react@14.x - React testing
      - playwright@1.x - E2E testing

      ### Developer Experience (Development)
      - eslint@8.x - Linting
      - prettier@3.x - Code formatting
      - @types/node - Node.js types
      - @types/react - React types

      ## For Stack: hybrid_nextjs_fastapi_expo

      Include all above, PLUS:

      ### Python Backend (requirements.txt)
      - fastapi>=0.109.0 - Web framework
      - pydantic>=2.5.0 - Data validation
      - uvicorn>=0.27.0 - ASGI server
      - sqlalchemy>=2.0.0 - ORM
      - alembic>=1.13.0 - Migrations
      - python-jose>=3.3.0 - JWT handling
      - passlib>=1.7.4 - Password hashing
      - python-dotenv>=1.0.0 - Environment variables

      ### Python Development
      - pytest>=7.4.0 - Testing
      - pytest-asyncio>=0.23.0 - Async testing
      - ruff>=0.1.0 - Linting
      - black>=23.0.0 - Formatting
      - mypy>=1.8.0 - Type checking

      # OUTPUT 1: DEPENDENCIES.md

      ```
      filename: DEPENDENCIES.md
      ---
      title: Project Dependencies
      owner: devops
      version: 1.0
      date: {{currentDate}}
      status: draft
      stack: {{stackChoice}}
      ---

      # Project Dependencies

      ## Executive Summary
      | Metric | Value |
      |--------|-------|
      | **Total Packages** | {count} |
      | **Production** | {count} |
      | **Development** | {count} |
      | **Security Status** | ðŸŸ¢ GREEN / ðŸŸ¡ YELLOW / ðŸ”´ RED |
      | **License Compliance** | âœ… All compatible |
      | **Avg. Maintenance Age** | < 6 months |

      ## Security Compliance Checklist
      - [ ] npm audit: 0 HIGH/CRITICAL vulnerabilities
      - [ ] All licenses reviewed and approved
      - [ ] No deprecated packages
      - [ ] All packages actively maintained
      - [ ] Lockfile committed (pnpm-lock.yaml)

      ## Dependency Policy
      | Policy | Enforcement |
      |--------|-------------|
      | Vulnerability Threshold | No HIGH or CRITICAL |
      | License Whitelist | MIT, Apache 2.0, BSD, ISC |
      | Maintenance Threshold | Updated within 12 months |
      | Update Cadence | Patch: weekly, Minor: monthly |

      ---

      ## Production Dependencies

      ### Core Framework
      [Dependencies with full format above]

      ### UI & Styling
      [Dependencies with full format above]

      ### State Management
      [Dependencies with full format above]

      ### Database
      [Dependencies with full format above]

      ### Authentication
      [Dependencies with full format above]

      ---

      ## Development Dependencies

      ### Testing
      [Dependencies with full format above]

      ### Linting & Formatting
      [Dependencies with full format above]

      ### Type Definitions
      [Dependencies with full format above]

      ---

      ## package.json Snippet
      ```json
      {
        "dependencies": {
          "next": "^14.1.0",
          "react": "^18.2.0",
          ...
        },
        "devDependencies": {
          "vitest": "^1.2.0",
          "eslint": "^8.56.0",
          ...
        }
      }
      ```

      ## Installation Commands
      ```bash
      # Install all dependencies
      pnpm install

      # Audit for vulnerabilities
      pnpm audit

      # Update to latest patch versions
      pnpm update
      ```
      ```

      # OUTPUT 2: dependency-proposal.md

      ```
      filename: dependency-proposal.md
      ---
      title: Dependency Proposal
      owner: devops
      version: 1.0
      date: {{currentDate}}
      status: pending_approval
      ---

      # Dependency Proposal for {{projectName}}

      ## Summary
      | Category | Count | Notes |
      |----------|-------|-------|
      | Production | {X} | Core runtime dependencies |
      | Development | {Y} | Build/test tooling |
      | Total | {Z} | |

      ## Security Audit Summary
      | Severity | Count | Action Required |
      |----------|-------|-----------------|
      | Critical | 0 | Must be 0 for approval |
      | High | 0 | Must be 0 for approval |
      | Medium | {X} | Review and accept risk |
      | Low | {Y} | Monitor in future updates |

      ## License Summary
      | License | Count | Compatible |
      |---------|-------|------------|
      | MIT | {X} | âœ… Yes |
      | Apache 2.0 | {Y} | âœ… Yes |
      | BSD | {Z} | âœ… Yes |
      | ISC | {W} | âœ… Yes |

      ## Bundle Size Analysis
      | Bundle | Size (gzipped) | Notes |
      |--------|----------------|-------|
      | Client JS | ~{X} KB | Target: < 200 KB |
      | CSS | ~{Y} KB | Tailwind purged |
      | Total First Load | ~{Z} KB | Target: < 300 KB |

      ## Update Strategy
      | Type | Frequency | Automation |
      |------|-----------|------------|
      | Patch | Weekly | Dependabot |
      | Minor | Monthly | Manual review |
      | Major | Quarterly | Team decision |

      ## Risk Assessment
      | Dependency | Risk | Mitigation |
      |------------|------|------------|
      | {package} | {risk description} | {mitigation strategy} |

      ## Approval Checklist
      - [ ] Security audit passed (0 HIGH/CRITICAL)
      - [ ] License compliance verified
      - [ ] Bundle size within targets
      - [ ] All packages actively maintained
      - [ ] Lockfile will be committed
      - [ ] CI/CD will run npm audit on PRs

      ## Stakeholder Approval
      | Role | Name | Approved | Date |
      |------|------|----------|------|
      | Tech Lead | | â˜ | |
      | Security | | â˜ | |
      | Product | | â˜ | |
      ```

      # QUALITY CHECKLIST
      - [ ] All dependencies have version pinned (exact or caret)
      - [ ] Every production dependency links to a PRD requirement
      - [ ] No duplicate functionality (e.g., don't include both Axios and Fetch wrapper)
      - [ ] Security status verified for all packages
      - [ ] License compatibility confirmed
      - [ ] Bundle size estimates provided
      - [ ] Installation commands tested

      Generate both files now for stack: {{stackChoice}}

# Validation rules
validators:
  presence:
    description: "Check if all required files exist"
    implementation: "file_exists_check"
    
  markdown_frontmatter:
    description: "Ensure markdown files have required frontmatter"
    required_fields: ["title", "owner", "version", "date", "status"]
    implementation: "frontmatter_parser"
    
  content_quality:
    description: "Check content is not empty or obviously incomplete"
    min_length: 100
    implementation: "content_length_check"
    
  content_coverage:
    description: "Ensure sufficient content coverage"
    requirements:
      PRD.md: "at_least_5_requirements"
      data-model.md: "has_tables"
      api-spec.json: "has_endpoints"
      tasks.md: "at_least_10_tasks"
    implementation: "coverage_analysis"
    
  api_openapi:
    description: "Validate OpenAPI specification"
    version: "3.0"
    implementation: "openapi_validator"
    
  stack_approved:
    description: "Check if stack has been approved by user"
    implementation: "database_field_check"
    field: "stack_approved"
    expected_value: true
    
  dependencies_approved:
    description: "Check if dependencies have been approved by user"
    implementation: "database_field_check"
    field: "dependencies_approved"
    expected_value: true
    
  policy_check:
    description: "Run dependency policy scripts"
    scripts:
      - "npm_audit"
      - "pip_audit"
      - "no_deprecated"
      - "no_outdated"
    implementation: "script_execution"
    
  tasks_dag:
    description: "Ensure no circular dependencies in task list"
    implementation: "dependency_graph_analysis"
    
  handoff_complete:
    description: "Check HANDOFF.md is generated and complete"
    required_sections: ["project_context", "reading_order", "llm_prompt"]
    implementation: "handoff_validator"
    
  zip_created:
    description: "Verify ZIP archive is created and contains all files"
    required_files: ["HANDOFF.md", "constitution.md", "PRD.md", "architecture.md"]
    implementation: "zip_validation"
    
  requirement_format:
    description: "Validate requirements follow REQ-XXX-YYY format"
    pattern: "REQ-[A-Z]+-\\d{3}"
    min_count: 15
    implementation: "regex_pattern_check"
    
  requirement_traceability:
    description: "Ensure all PRD requirements are covered by tasks"
    source_artifact: "PRD.md"
    target_artifact: "tasks.md"
    implementation: "cross_reference_check"
    
  api_endpoint_coverage:
    description: "Ensure all API endpoints have corresponding tasks"
    source_artifact: "api-spec.json"
    target_artifact: "tasks.md"
    implementation: "api_task_mapping"
    
  cross_artifact_consistency:
    description: "Verify consistency across all artifacts"
    checks:
      - "All personas in PRD exist in personas.md"
      - "All REQ-IDs in tasks.md exist in PRD.md"
      - "All EPIC-IDs in tasks.md exist in epics.md"
      - "Stack choice in architecture.md matches approved stack"
    implementation: "multi_artifact_validation"
    
  quality_score:
    description: "Score artifact quality 0-100"
    criteria:
      frontmatter_complete: 10
      min_content_length: 20
      structured_sections: 30
      actionable_criteria: 40
    minimum_score: 70
    implementation: "quality_scoring"

# Security baseline (applies to all projects)
security_baseline:
  authentication:
    - "All passwords hashed with bcrypt (cost 10+)"
    - "JWT tokens with 1-hour expiry"
    - "HTTPS only (no HTTP)"
    
  data_protection:
    - "Sensitive data encrypted at rest (AES-256)"
    - "TLS 1.2+ for transit"
    
  compliance:
    - "GDPR-ready user data handling"
    - "Audit logs for sensitive operations"
    - "PII never in logs"
    
  scanning:
    - "npm audit (zero HIGH/CRITICAL)"
    - "pip-audit (zero HIGH/CRITICAL)"
    - "SAST scanning (SonarQube or Snyk)"
    
  testing:
    - "Unit test coverage >80%"
    - "E2E tests for critical flows"
    - "Security-focused test cases"
# Frontend UI/UX Standards
frontend_ui_standards:
  component_library: "shadcn/ui"
  icon_library: "lucide-react"
  styling: "Tailwind CSS"

  initialization_commands:
    - "pnpm dlx shadcn@latest init"
    - description: "Initializes shadcn/ui, installs cn utility, configures Tailwind, and sets up CSS variables"

  default_approach: "shadcn/ui (unless project requirements specify otherwise)"

  hard_rules:
    - "Always use shadcn components over custom components (DEFAULT)"
    - "Never create components yourself unless explicitly requested"
    - "Always install components using the CLI: pnpm dlx shadcn@latest add <component>"
    - "Always use standard Tailwind and shadcn color palette"
    - "Never use inline custom colors"
    - "Use lucide-react for all icons (DEFAULT)"

  flexibility_clause:
    principle: "User-Driven Customization"
    description: "If the user explicitly requests alternative UI libraries or dependencies, honor that request"
    examples:
      - "User requests: 'Use Material-UI instead' â†’ Switch to Material-UI"
      - "User requests: 'Add Framer Motion for animations' â†’ Include Framer Motion"
      - "User requests: 'Use Bootstrap' â†’ Switch to Bootstrap"
      - "User does not specify â†’ Default to shadcn/ui"
    guidelines:
      - "Only deviate from shadcn/ui when user explicitly requests it in project brief or PRD"
      - "Document all alternative dependencies in DEPENDENCIES.md with rationale"
      - "Maintain accessibility and design consistency standards regardless of UI library choice"
      - "Update architecture.md to reflect non-standard UI decisions"

  common_components_to_install:
    - button: "Interactive action elements"
    - card: "Content containers with header/footer"
    - input: "Form input fields"
    - badge: "Status and tag labels"
    - dialog: "Modal dialogs and confirmations"
    - dropdown-menu: "Dropdown menus and navigation"
    - tabs: "Tabbed content sections"
    - select: "Select dropdowns"
    - textarea: "Multi-line text inputs"
    - form: "Form composition helpers"
    - alert: "Alert messages and notifications"
    - toast: "Toast notifications"

  color_system:
    primary: "Primary action color (default: slate-900)"
    secondary: "Secondary elements"
    destructive: "Dangerous actions (red)"
    muted: "Disabled or secondary text"
    accent: "Accent highlights"
    note: "Always use shadcn preset colors, never custom hex/rgb values inline"

  typography:
    - "Use Tailwind text utilities for all typography"
    - "Font sizes: text-xs, text-sm, text-base, text-lg, text-xl, text-2xl, text-4xl"
    - "Font weights: font-normal, font-medium, font-semibold, font-bold"
    - "Always apply proper contrast ratios for accessibility (WCAG AA minimum)"

  spacing_patterns:
    - "Use Tailwind spacing scale: p-2, p-4, p-6, p-8 for padding"
    - "Use gap-2, gap-4, gap-6, gap-8 for flex/grid gaps"
    - "Consistent margins: mb-4, mb-6, mb-8"

  responsive_design:
    - "Mobile-first approach"
    - "Use Tailwind breakpoints: sm, md, lg, xl, 2xl"
    - "Example: md:grid-cols-2 lg:grid-cols-3"

  accessibility:
    - "Use semantic HTML: <button>, <input>, <form>, <nav>"
    - "Include aria-labels for interactive elements"
    - "Ensure keyboard navigation works"
    - "Test with screen readers"
    - "Minimum touch target size: 44x44px"

  dev_setup:
    step_1: "pnpm dlx shadcn@latest init"
    step_2: "Add individual components as needed: pnpm dlx shadcn@latest add button"
    step_3: "Import and use in components: import { Button } from '@/components/ui/button'"
    step_4: "Follow shadcn/ui documentation at ui.shadcn.com for component patterns"

# File structure templates
file_structure:
  project_directory: "/projects/{slug}/"
  specs_directory: "/projects/{slug}/specs/"
  artifact_versioning: "v{version}/"
  
  zip_structure:
    root_files:
      - "constitution.md"
      - "project-brief.md"
      - "personas.md"
      - "README.md"
      - "HANDOFF.md"
    specs_folder:
      - "PRD.md"
      - "data-model.md"
      - "api-spec.json"
      - "architecture.md"
      - "epics.md"
      - "tasks.md"
      - "plan.md"
      - "DEPENDENCIES.md"
    config_folder:
      - ".ai-config/analyst_prompt.md"
      - ".ai-config/pm_prompt.md"
      - ".ai-config/architect_prompt.md"
      - ".ai-config/scrummaster_prompt.md"
      - ".ai-config/devops_prompt.md"
      - ".ai-config/validators.yml"
    docs_folder:
      - "docs/security-baseline.md"
      - "docs/DEPS_NOTES.md"

# LLM configuration
llm_config:
  provider: "gemini"
  model: "gemini-2.5-flash"
  max_tokens: 16384  # Increased for complex outputs
  temperature: 0.5   # Balanced between creativity and consistency
  top_p: 0.95
  timeout_seconds: 180  # Increased for longer generations
  
  # Phase-specific overrides for optimal output quality
  phase_overrides:
    ANALYSIS:
      temperature: 0.7    # Higher creativity for ideation
      max_tokens: 12288
      
    STACK_SELECTION:
      temperature: 0.3    # More deterministic for technical decisions
      max_tokens: 8192
      
    SPEC:
      temperature: 0.3    # Precise for requirements
      max_tokens: 16384
      
    DEPENDENCIES:
      temperature: 0.2    # Very deterministic for dependency selection
      max_tokens: 12288
      
    SOLUTIONING:
      temperature: 0.4    # Balanced for architecture + tasks
      max_tokens: 32768   # Largest output phase
      
    DONE:
      temperature: 0.3
      max_tokens: 16384
  
  # Rate limiting and cost management
  rate_limit:
    requests_per_minute: 60
    tokens_per_hour: 100000
    
  cost_management:
    max_cost_per_project: 50.0  # USD
    token_cost_per_million: 0.5

# Project defaults
project_defaults:
  current_phase: "ANALYSIS"
  phases_completed: []
  stack_choice: null
  stack_approved: false
  dependencies_approved: false
  artifact_versions: {}
  zip_ready: false