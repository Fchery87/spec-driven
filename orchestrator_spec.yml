# Spec-Driven Orchestrator Configuration
# Version: 3.0
# Date: 2025-12-10
# Updated: Added Hybrid Clarification, VALIDATE phase, Constitutional Articles,
#          Uncertainty Markers, Test-First Requirements, Task Parallelism, Quality Checklists

# =============================================================================
# CONSTITUTIONAL ARTICLES (Inspired by GitHub Spec Kit + BMAD Method)
# These principles govern ALL spec generation and must be enforced
# =============================================================================
constitutional_articles:
  article_1_library_first:
    name: "Library-First Principle"
    mandate: "Every feature begins as a reusable module with clear boundaries"
    enforcement: "architecture.md must show modular boundaries for each feature"
    rationale: "Modularity enables testing, reuse, and maintainability"
    
  article_2_test_first:
    name: "Test-First Imperative"
    mandate: "No implementation code before tests are specified"
    enforcement: "tasks.md must list test specifications BEFORE implementation notes"
    rationale: "Tests define behavior; implementation fulfills that behavior"
    
  article_3_simplicity:
    name: "Simplicity Gate"
    mandate: "Maximum 3 projects/services for MVP; justify additional complexity"
    enforcement: "architecture.md must include complexity tracking section"
    rationale: "Start simple, add complexity only when proven necessary"
    
  article_4_anti_abstraction:
    name: "Anti-Abstraction"
    mandate: "Use framework directly; no unnecessary wrappers or abstractions"
    enforcement: "DEPENDENCIES.md must justify each abstraction layer"
    rationale: "Abstractions add maintenance cost; use only when essential"
    
  article_5_integration_first:
    name: "Integration-First Testing"
    mandate: "Prefer real databases over mocks; test in realistic environments"
    enforcement: "Test configuration in tasks.md must specify real service usage"
    rationale: "Mocks hide real integration issues; real tests find real bugs"

# =============================================================================
# WORKFLOW TRACKS (Scale-Adaptive - Inspired by BMAD Method)
# =============================================================================
workflow_tracks:
  quick_flow:
    name: "Quick Flow"
    description: "Fast path for bug fixes, small features, and hotfixes"
    use_for: ["Bug fixes", "Small features", "Hotfixes", "Simple CRUD"]
    phases: ["ANALYSIS_LITE", "SOLUTIONING_LITE", "DONE"]
    time_to_start: "< 5 minutes"
    outputs: ["tech-spec.md", "tasks.md", "HANDOFF.md"]
    skip_gates: true
    
  standard:
    name: "Standard Flow"
    description: "Full workflow for products, platforms, and new features"
    use_for: ["Products", "Platforms", "New features", "MVPs"]
    phases: ["ANALYSIS", "STACK_SELECTION", "SPEC", "DEPENDENCIES", "SOLUTIONING", "VALIDATE", "DONE"]
    time_to_start: "< 30 minutes"
    outputs: "all"
    default: true
    
  enterprise:
    name: "Enterprise Flow"
    description: "Extended workflow with compliance and security gates"
    use_for: ["Compliance-heavy projects", "Large scale", "Multi-team", "Regulated industries"]
    phases: ["ANALYSIS", "STACK_SELECTION", "SPEC", "SECURITY_REVIEW", "DEPENDENCIES", "COMPLIANCE_CHECK", "SOLUTIONING", "VALIDATE", "DONE"]
    time_to_start: "< 60 minutes"
    outputs: "all + compliance artifacts"
    additional_gates: ["security_approved", "compliance_approved"]

# =============================================================================
# PHASE WORKFLOW DEFINITION
# =============================================================================
phases:
  ANALYSIS:
    name: "ANALYSIS"
    description: "Clarify requirements through guided Q&A with uncertainty resolution"
    owner: "analyst"
    duration_minutes: 30
    inputs: ["user_idea"]
    outputs: ["constitution.md", "project-brief.md", "project-classification.json", "personas.md"]
    next_phase: "STACK_SELECTION"
    validators: ["presence", "markdown_frontmatter", "content_quality", "no_unresolved_clarifications"]
    allow_regeneration: true
    max_regeneration_attempts: 3
    
    # Hybrid Clarification Mode (NEW - Inspired by GitHub Spec Kit)
    clarification:
      enabled: true
      default_mode: "hybrid"  # Options: interactive | auto_resolve | hybrid
      max_questions: 10
      allow_skip: true
      uncertainty_marker: "[NEEDS CLARIFICATION: {question}]"
      assumption_marker: "[AI ASSUMED: {assumption} - {rationale}]"
      modes:
        interactive:
          description: "User answers all clarification questions before proceeding"
          flow: "AI pauses → Shows questions → User answers → AI proceeds"
          best_for: "Complex projects, compliance-heavy, precise requirements"
        auto_resolve:
          description: "AI makes reasonable assumptions and documents them"
          flow: "AI proceeds → Documents assumptions as [AI ASSUMED: rationale]"
          best_for: "Fast iteration, MVPs, familiar domains"
        hybrid:
          description: "User chooses which questions to answer; AI resolves rest"
          flow: |
            1. AI generates output with [NEEDS CLARIFICATION] markers
            2. User sees question panel with options:
               - Answer specific questions manually
               - "Auto-resolve remaining" → AI assumes rest
               - "Auto-resolve all" → Skip entirely (current speed)
            3. Auto-resolved items marked: [AI ASSUMED: {assumption}]
          best_for: "Balanced control and speed"
    
    # Quality Checklist for this phase
    quality_checklist:
      - "All FOUR files generated (constitution, brief, classification, personas)"
      - "No unresolved [NEEDS CLARIFICATION] markers (unless auto-resolved)"
      - "3-5 distinct personas (not variations of same user)"
      - "Each persona has specific pain points (not generic)"
      - "Success metrics are SMART format"
      - "constitution.md has 5+ guiding principles with rationale"
      - "project-brief.md has TAM/SAM/SOM analysis"
      - "Competitive analysis identifies real or realistic competitors"
    
  STACK_SELECTION:
    name: "STACK_SELECTION"
    description: "Architect proposes optimal stack based on requirements; user approves, modifies, or customizes"
    owner: "architect"
    duration_minutes: 25
    inputs: ["project-brief.md", "project-classification.json", "personas.md", "constitution.md"]
    outputs: ["stack-analysis.md", "stack-decision.md", "stack-rationale.md", "stack.json"]
    depends_on: ["ANALYSIS"]
    gates: ["stack_approved"]
    next_phase: "SPEC"
    validators: ["presence", "stack_approved", "stack_completeness", "stack_json_check"]
    mode: "hybrid"
    process:
      - "1. Architect analyzes requirements from project-brief.md"
      - "2. Architect considers scale, platforms, team expertise, integrations"
      - "3. Architect proposes best-fit template OR custom stack"
      - "4. User can: Accept proposal, Pick different template, Fully customize"
      - "5. Approval gate confirms final choice"
    quality_checklist:
      - "stack-decision.md and stack-rationale.md both exist"
      - "All required layers defined (frontend, mobile, backend, database, deployment)"
      - "Decision matrix with weighted scoring provided"
      - "Alternatives considered with rationale for rejection"
      - "Trade-offs explicitly documented with mitigations"
      - "Scaling considerations addressed"
      - "Technical preferences from brief applied or justified if overridden"
    
  SPEC:
    name: "SPEC"
    description: "Generate detailed specifications and design system"
    owner: ["pm", "architect"]
    duration_minutes: 60
    inputs: ["project-brief.md", "personas.md", "approved_stack"]
    outputs: ["PRD.md", "data-model.md", "api-spec.json", "design-system.md", "component-inventory.md", "user-flows.md"]
    depends_on: ["ANALYSIS", "STACK_SELECTION"]
    next_phase: "DEPENDENCIES"
    validators: ["markdown_frontmatter", "api_openapi", "presence", "content_coverage", "requirement_format", "design_system_compliance"]
    allow_regeneration: true
    max_regeneration_attempts: 3
    quality_checklist:
      - "Minimum 15 functional requirements for MVP"
      - "Each requirement has >= 2 Gherkin acceptance criteria"
      - "All MVP requirements link to a persona from personas.md"
      - "Traceability matrix complete with no orphaned requirements"
      - "NFRs have measurable targets (not vague statements)"
      - "No circular dependencies between requirements"
      - "api-spec.json is valid OpenAPI 3.0.3"
      - "All endpoints have error responses defined"
      - "design-system.md has NO purple/indigo as primary color"
      - "design-system.md uses OKLCH color format"
      - "design-system.md has exactly 4 typography sizes"
      - "design-system.md spacing values all divisible by 4 or 8"
      - "design-system.md includes Framer Motion animation tokens"
      - "component-inventory.md links to shadcn docs for each component"
      - "user-flows.md has Mermaid diagrams for all major PRD flows"
    
  DEPENDENCIES:
    name: "DEPENDENCIES"
    description: "Define and approve project dependencies"
    owner: "devops"
    duration_minutes: 30
    inputs: ["PRD.md", "approved_stack"]
    outputs: ["DEPENDENCIES.md", "dependencies.json"]
    depends_on: ["SPEC"]
    gates: ["dependencies_approved"]
    next_phase: "SOLUTIONING"
    validators: ["presence", "dependencies_approved", "dependencies_json_check"]
    quality_checklist:
      - "All dependencies have version pinned (exact or caret)"
      - "Every production dependency links to a PRD requirement"
      - "No duplicate functionality (e.g., don't include both Axios and Fetch wrapper)"
      - "No deprecated packages included"
      - "Licenses recorded and compatible"
      - "Bundle size estimates provided"
      - "All packages actively maintained (updated within 12 months)"
      - "Article 4 (Anti-Abstraction) compliance: abstraction layers justified"
    
  SOLUTIONING:
    name: "SOLUTIONING"
    description: "Create architecture and task breakdown with test-first approach"
    owner: ["architect", "scrummaster"]
    duration_minutes: 60
    inputs: ["PRD.md", "data-model.md", "api-spec.json", "DEPENDENCIES.md"]
    outputs: ["architecture.md", "epics.md", "tasks.md", "plan.md"]
    depends_on: ["SPEC", "DEPENDENCIES"]
    next_phase: "VALIDATE"
    validators: ["markdown_frontmatter", "tasks_dag", "presence", "content_coverage", "requirement_traceability", "test_first_compliance"]
    allow_regeneration: true
    max_regeneration_attempts: 3
    quality_checklist:
      - "plan.md has ALL 9 sections (not truncated)"
      - "epics.md covers all PRD epics"
      - "tasks.md has minimum 15 MVP tasks"
      - "Every task links to REQ-XXX-YYY from PRD"
      - "No circular dependencies in task graph"
      - "All tasks have Gherkin-style acceptance criteria"
      - "Story points add up correctly per epic"
      - "Timeline is realistic (not overly optimistic)"
      - "Tests listed BEFORE implementation notes in each task (Article 2)"
      - "Parallel tasks marked with [P] for concurrent execution"
      - "Task groups organized (Sequential vs Parallel)"
      - "Article 1 (Library-First): Features structured as modules"
      - "Article 3 (Simplicity): <= 3 services for MVP or justified"
      - "Article 5 (Integration-First): Test config specifies real services"
    
  VALIDATE:
    name: "VALIDATE"
    description: "Cross-artifact consistency and coverage analysis"
    owner: "validator"
    duration_minutes: 15
    inputs: ["all_previous_artifacts"]
    outputs: ["validation-report.md", "coverage-matrix.md"]
    depends_on: ["SOLUTIONING"]
    next_phase: "DONE"
    # NOTE: Validator names (below) must exist under the top-level `validators:` section.
    # These checks are enforced deterministically (not via LLM) to prevent spec/implementation drift.
    validators: ["requirement_traceability", "api_endpoint_coverage", "cross_artifact_consistency", "constitutional_compliance"]
    quality_checklist:
      - "Every REQ-XXX in PRD maps to at least one task"
      - "All API endpoints have corresponding data model entities"
      - "Design system tokens used consistently in component-inventory"
      - "No orphaned user stories without acceptance criteria"
      - "Stack choice in architecture.md matches approved stack"
      - "All personas in PRD exist in personas.md"
      - "All EPIC-IDs in tasks.md exist in epics.md"
      - "Constitutional Articles 1-5 compliance verified"
      - "No unresolved [NEEDS CLARIFICATION] markers"
      - "All [AI ASSUMED] items documented in validation report"
    validation_checks:
      requirement_to_task_mapping:
        description: "Every PRD requirement has at least one implementing task"
        source: "PRD.md"
        target: "tasks.md"
        pattern: "REQ-[A-Z]+-\\d{3}"
      api_to_data_model_mapping:
        description: "All API response schemas have corresponding data model entities"
        source: "api-spec.json"
        target: "data-model.md"
      persona_consistency:
        description: "All personas referenced in PRD exist in personas.md"
        source: "PRD.md"
        target: "personas.md"
      stack_consistency:
        description: "Technologies in architecture.md match stack-decision.md"
        source: "architecture.md"
        target: "stack-decision.md"
    
  DONE:
    name: "DONE"
    description: "Generate handoff and ZIP package"
    owner: "orchestrator"
    duration_minutes: 10
    inputs: ["all_previous_artifacts"]
    outputs: ["README.md", "HANDOFF.md", "project.zip"]
    depends_on: ["VALIDATE"]
    validators: ["handoff_complete", "zip_created", "cross_artifact_consistency"]
    quality_checklist:
      - "HANDOFF.md generated with complete LLM prompt"
      - "All artifacts included in ZIP"
      - "README.md provides quick start guide"
      - "Document reading order specified"
      - "Stack summary matches approved stack"
      - "Security baseline checklist included"
      - "Validation report shows all checks passed"
      - "No unresolved issues from VALIDATE phase"

# Technology Stack Configuration
# Mode: hybrid - Architect proposes based on requirements, user can accept, modify, or go custom
stack_selection_mode: "hybrid"

# Stack Templates (Quick-start options)
# These are SUGGESTIONS, not requirements. The Architect agent will propose the best fit
# based on project requirements, or the user can fully customize.
stack_templates:

  # === FULL-STACK WEB + MOBILE ===
  nextjs_fullstack_expo:
    name: "Next.js Full-Stack + Expo Mobile"
    description: "Unified TypeScript codebase with Next.js App Router, Expo mobile, and a serverless-ready Neon + Drizzle backend"
    composition:
      frontend: "Next.js 14 (App Router)"
      mobile: "Expo with React Native"
      backend: "Next.js API routes / tRPC"
      database: "Neon Postgres + Drizzle ORM"
      auth: "Better Auth"
      storage: "Cloudflare R2 (S3-compatible)"
      deployment: "Vercel"
    best_for: ["MVPs", "dashboards", "CRUD SaaS", "low ops footprint"]
    strengths: ["Single language", "unified codebase", "fast iteration", "integrated API"]
    tradeoffs: ["Less suitable for heavy backend compute", "mobile distribution adds release complexity"]
    scaling: "Good for <10k DAU, managed infrastructure"
    
  hybrid_nextjs_fastapi:
    name: "Next.js + FastAPI + Expo"
    description: "Decoupled services with Python backend for heavy compute"
    composition:
      frontend: "Next.js 14"
      mobile: "Expo with React Native"
      backend: "FastAPI (Python)"
      database: "PostgreSQL with SQLAlchemy"
      deployment: "Separate infra (Vercel + Railway/Render)"
    best_for: ["AI/ML applications", "ETL/data pipelines", "long-running jobs"]
    strengths: ["Python ecosystem", "decoupled services", "async workers"]
    tradeoffs: ["More operational complexity", "separate deployments"]
    scaling: "Good for 10k-100k DAU, complex backend logic"

  # === WEB-ONLY (NO MOBILE) ===
  nextjs_web_app:
    name: "Next.js Web App (Neon + Drizzle + R2 + Better Auth)"
    description: "Full-stack Next.js App Router with Neon Postgres, Drizzle ORM, Cloudflare R2 storage, and Better Auth"
    composition:
      frontend: "Next.js 14 (App Router)"
      mobile: "None (responsive web design)"
      backend: "Next.js API routes / Server Actions"
      database: "Neon Postgres + Drizzle ORM"
      auth: "Better Auth"
      storage: "Cloudflare R2 (S3-compatible)"
      deployment: "Vercel"
    best_for: ["Web apps", "admin dashboards", "internal tools", "B2B SaaS", "CRUD SaaS"]
    strengths: ["Fast iteration", "type-safe DB access", "simple ops", "R2-backed media storage"]
    tradeoffs: ["No native mobile experience"]
    scaling: "Good for any scale with proper caching; Neon + serverless patterns support growth"

  nextjs_web_only:
    name: "Next.js Web Only (Legacy ID)"
    description: "Legacy template id retained for compatibility; prefer nextjs_web_app"
    composition:
      frontend: "Next.js 14 (App Router)"
      mobile: "None (responsive web design)"
      backend: "Next.js API routes / Server Actions"
      database: "Neon Postgres + Drizzle ORM"
      auth: "Better Auth"
      storage: "Cloudflare R2 (S3-compatible)"
      deployment: "Vercel"
    best_for: ["Web apps", "admin dashboards", "internal tools", "B2B SaaS"]
    strengths: ["Simplest setup", "server components", "no mobile complexity"]
    tradeoffs: ["No native mobile experience"]
    scaling: "Good for any scale with proper caching"

  react_express:
    name: "React SPA + Express API"
    description: "Traditional SPA with separate Node.js backend"
    composition:
      frontend: "React 18 + Vite"
      mobile: "None (or add React Native later)"
      backend: "Express.js or Fastify"
      database: "PostgreSQL or MongoDB"
      deployment: "Any (Vercel, AWS, Railway, etc.)"
    best_for: ["Traditional SPAs", "custom server needs", "WebSocket apps"]
    strengths: ["Full control", "flexible architecture", "mature ecosystem"]
    tradeoffs: ["More setup required", "manual optimizations"]
    scaling: "Highly flexible based on backend design"

  vue_nuxt:
    name: "Vue + Nuxt Full-Stack"
    description: "Vue.js ecosystem with Nuxt for SSR/SSG"
    composition:
      frontend: "Nuxt 3 (Vue 3)"
      mobile: "None (or Capacitor/Ionic)"
      backend: "Nuxt server routes / Nitro"
      database: "PostgreSQL with Prisma"
      deployment: "Vercel, Netlify, or Cloudflare"
    best_for: ["Vue teams", "content-heavy sites", "progressive enhancement"]
    strengths: ["Excellent DX", "auto-imports", "hybrid rendering"]
    tradeoffs: ["Smaller ecosystem than React"]
    scaling: "Good for most use cases"

  svelte_kit:
    name: "SvelteKit Full-Stack"
    description: "Svelte with SvelteKit for full-stack apps"
    composition:
      frontend: "SvelteKit (Svelte 5)"
      mobile: "None (or Capacitor)"
      backend: "SvelteKit endpoints"
      database: "PostgreSQL with Drizzle"
      deployment: "Vercel, Cloudflare, or Netlify"
    best_for: ["Performance-critical apps", "smaller bundle size", "simpler mental model"]
    strengths: ["Smallest bundle", "no virtual DOM", "excellent performance"]
    tradeoffs: ["Smaller ecosystem", "fewer libraries"]
    scaling: "Excellent performance at any scale"

  # === STATIC / JAMstack ===
  astro_static:
    name: "Astro Static Site"
    description: "Content-focused static site with optional islands"
    composition:
      frontend: "Astro with React/Vue/Svelte islands"
      mobile: "None (responsive web)"
      backend: "Serverless functions (optional)"
      database: "Headless CMS (Sanity, Contentful, Strapi) or none"
      deployment: "Vercel, Netlify, or Cloudflare Pages"
    best_for: ["Marketing sites", "blogs", "documentation", "low interactivity"]
    strengths: ["Zero JS by default", "fastest load times", "SEO-optimized"]
    tradeoffs: ["Limited interactivity", "rebuild for content updates"]
    scaling: "CDN-based, infinitely scalable"

  # === SERVERLESS / EDGE ===
  serverless_edge:
    name: "Serverless Edge Stack"
    description: "Edge-first architecture for global low-latency"
    composition:
      frontend: "Next.js or Remix"
      mobile: "None or React Native"
      backend: "Cloudflare Workers / Vercel Edge Functions"
      database: "Turso, PlanetScale, or Supabase"
      deployment: "Cloudflare or Vercel"
    best_for: ["Global apps", "low latency requirements", "cost optimization"]
    strengths: ["Sub-50ms latency globally", "auto-scaling", "pay-per-use"]
    tradeoffs: ["Edge runtime limitations", "cold starts"]
    scaling: "Global edge, virtually unlimited"

  # === BACKEND-HEAVY ===
  django_htmx:
    name: "Django + HTMX"
    description: "Python-first with hypermedia approach"
    composition:
      frontend: "Django templates + HTMX + Alpine.js"
      mobile: "None (or Django REST + mobile app)"
      backend: "Django"
      database: "PostgreSQL"
      deployment: "Railway, Render, or AWS"
    best_for: ["Python teams", "rapid prototyping", "admin-heavy apps"]
    strengths: ["Batteries included", "excellent admin", "mature ecosystem"]
    tradeoffs: ["Less interactive UIs", "monolithic by default"]
    scaling: "Good with proper caching and async views"

  go_react:
    name: "Go Backend + React Frontend"
    description: "High-performance Go backend with React SPA"
    composition:
      frontend: "React 18 + Vite"
      mobile: "None or React Native"
      backend: "Go (Gin, Echo, or Chi)"
      database: "PostgreSQL"
      deployment: "Docker on any cloud"
    best_for: ["High-throughput APIs", "microservices", "performance-critical"]
    strengths: ["Fastest backend", "low memory", "great concurrency"]
    tradeoffs: ["Two languages", "more verbose backend"]
    scaling: "Excellent for high-traffic systems"

  # === MOBILE-FIRST ===
  flutter_firebase:
    name: "Flutter + Firebase"
    description: "Cross-platform mobile with Firebase backend"
    composition:
      frontend: "Flutter Web (optional)"
      mobile: "Flutter (iOS + Android)"
      backend: "Firebase (Firestore, Auth, Functions)"
      database: "Firestore (NoSQL)"
      deployment: "Firebase Hosting + App Stores"
    best_for: ["Mobile-first apps", "real-time features", "rapid prototyping"]
    strengths: ["Single codebase for iOS/Android", "real-time sync", "offline-first"]
    tradeoffs: ["Dart language", "Firebase vendor lock-in", "Firestore limitations"]
    scaling: "Good for most mobile apps, watch Firestore costs"

  react_native_supabase:
    name: "React Native + Supabase"
    description: "React Native mobile with Supabase backend"
    composition:
      frontend: "React (web, optional)"
      mobile: "React Native (bare or Expo)"
      backend: "Supabase (PostgreSQL + Auth + Storage)"
      database: "PostgreSQL (via Supabase)"
      deployment: "Supabase + App Stores"
    best_for: ["Mobile apps needing SQL", "real-time features", "open-source preference"]
    strengths: ["PostgreSQL power", "real-time subscriptions", "self-hostable"]
    tradeoffs: ["Less mature than Firebase"]
    scaling: "Good, scales with PostgreSQL"

# Custom Stack Schema
# When user selects "custom", they define each layer
custom_stack_schema:
  frontend:
    framework:
      type: "string"
      options: ["React", "Vue", "Svelte", "Angular", "Solid", "Qwik", "Vanilla JS", "None"]
      description: "Core UI framework"
    meta_framework:
      type: "string | null"
      options: ["Next.js", "Nuxt", "SvelteKit", "Remix", "Astro", "Vite SPA", "None"]
      description: "Full-stack framework (optional)"
    styling:
      type: "string"
      options: ["Tailwind CSS", "CSS Modules", "styled-components", "Emotion", "Vanilla CSS", "Sass"]
      default: "Tailwind CSS"
    ui_library:
      type: "string"
      options: ["shadcn/ui", "Radix UI", "Headless UI", "Material UI", "Chakra UI", "Ant Design", "Custom", "None"]
      default: "shadcn/ui"
      
  mobile:
    platform:
      type: "string"
      options: ["none", "expo", "react-native-bare", "flutter", "native-ios", "native-android", "capacitor", "ionic"]
      default: "none"
      description: "Mobile platform choice"
      
  backend:
    language:
      type: "string"
      options: ["TypeScript", "Python", "Go", "Rust", "Ruby", "Java", "PHP", "C#", "Serverless-only"]
      description: "Primary backend language"
    framework:
      type: "string"
      options_by_language:
        TypeScript: ["Express", "Fastify", "Hono", "tRPC", "Next.js API", "NestJS", "Elysia"]
        Python: ["FastAPI", "Django", "Flask", "Litestar"]
        Go: ["Gin", "Echo", "Chi", "Fiber"]
        Rust: ["Axum", "Actix", "Rocket"]
        Ruby: ["Rails", "Sinatra", "Hanami"]
        Java: ["Spring Boot", "Quarkus", "Micronaut"]
        PHP: ["Laravel", "Symfony"]
        "C#": [".NET Core", "ASP.NET"]
      description: "Backend framework"
      
  database:
    type:
      type: "string"
      options: ["sql", "nosql", "edge", "graph", "none"]
      description: "Database paradigm"
    provider:
      type: "string"
      options_by_type:
        sql: ["PostgreSQL", "MySQL", "SQLite", "SQL Server", "CockroachDB"]
        nosql: ["MongoDB", "DynamoDB", "Firestore", "CouchDB"]
        edge: ["Turso", "PlanetScale", "Neon", "Supabase", "D1"]
        graph: ["Neo4j", "DGraph", "ArangoDB"]
      description: "Database provider"
    orm:
      type: "string"
      options: ["Prisma", "Drizzle", "TypeORM", "Sequelize", "SQLAlchemy", "Django ORM", "GORM", "Raw SQL"]
      description: "ORM/query builder"
      
  deployment:
    platform:
      type: "string"
      options: ["Vercel", "Netlify", "Cloudflare", "AWS", "GCP", "Azure", "Railway", "Render", "Fly.io", "DigitalOcean", "Self-hosted"]
      description: "Deployment platform"
    architecture:
      type: "string"
      options: ["monolith", "modular-monolith", "microservices", "serverless", "edge"]
      default: "monolith"
      description: "Deployment architecture"

# Technical Preferences (User can specify in project brief)
# These override defaults when generating dependencies
technical_preferences_schema:
  state_management:
    options: ["zustand", "redux", "jotai", "recoil", "mobx", "valtio", "none"]
    default: "zustand"
  data_fetching:
    options: ["tanstack-query", "swr", "rtk-query", "apollo", "urql", "fetch"]
    default: "tanstack-query"
  forms:
    options: ["react-hook-form", "formik", "react-final-form", "native"]
    default: "react-hook-form"
  validation:
    options: ["zod", "yup", "joi", "valibot", "arktype"]
    default: "zod"
  http_client:
    options: ["fetch", "axios", "ky", "got"]
    default: "fetch"
  testing:
    options: ["vitest", "jest", "mocha"]
    default: "vitest"
  e2e_testing:
    options: ["playwright", "cypress", "none"]
    default: "playwright"
  animation:
    options: ["framer-motion", "react-spring", "gsap", "none"]
    default: "framer-motion"

# Agent definitions
agents:
  analyst:
    role: "Business Analyst and Product Strategist"
    perspective: "CEO/CPO"
    responsibilities:
      - "Ask clarifying questions to understand project vision"
      - "Generate constitution, project brief, and personas"
      - "Classify project type, scale tier, platforms, and backend complexity"
      - "Mark uncertainties for user resolution or AI auto-resolution"
    prompt_template: |
      # ROLE
      You are a Business Analyst and Product Strategist operating as a CEO/CPO advisor.
      Your expertise spans market analysis, user research, and strategic planning.

      # OBJECTIVE
      Generate three comprehensive analysis documents plus a classification summary that will guide all subsequent development phases.
      These documents must be detailed enough to serve as the foundation for PRD creation and architecture decisions.

      # PROJECT DESCRIPTION
      {{projectIdea}}

      # =============================================================================
      # UNCERTAINTY PROTOCOL (MANDATORY - Inspired by GitHub Spec Kit)
      # =============================================================================
      When generating these documents, you MUST follow this protocol:
      
      1. **Mark ALL Ambiguities**: Use `[NEEDS CLARIFICATION: specific question]`
         - If the project description doesn't specify something important, MARK IT
         - Don't guess or assume - surface the uncertainty
         
      2. **Track Assumptions**: When you must make an assumption, use:
         `[AI ASSUMED: {what you assumed} - {why this is reasonable}]`
         
      3. **Categories to Check for Uncertainty**:
         - Target users: Who exactly? Demographics? Technical level?
         - Scale: How many users? Data volume? Traffic expectations?
         - Platforms: Web only? Mobile? Desktop? All?
         - Authentication: Email/password? OAuth? SSO? MFA?
         - Monetization: Free? Freemium? Subscription? One-time?
         - Compliance: GDPR? HIPAA? SOC2? None?
         - Timeline: MVP deadline? Phase 2 timeline?
         - Budget: Hosting budget? Third-party service limits?
         
      4. **Example Markers**:
         - `[NEEDS CLARIFICATION: What authentication methods should be supported - email/password only, or also OAuth providers like Google/GitHub?]`
         - `[AI ASSUMED: Target scale is <10k users based on MVP focus - adjust if enterprise scale needed]`
         - `[NEEDS CLARIFICATION: Is offline functionality required for the mobile app?]`
      
      5. **Clarification Mode**: {{clarificationMode}}
         - If "interactive": Generate [NEEDS CLARIFICATION] markers and STOP for user input
         - If "hybrid" (DEFAULT): Generate [NEEDS CLARIFICATION] markers; user will choose which to answer
         - If "auto_resolve": Make reasonable assumptions and document with [AI ASSUMED]
           IMPORTANT: When auto_resolve mode is active, you MUST NOT leave any [NEEDS CLARIFICATION] markers.
           Instead, make a reasonable assumption and use [AI ASSUMED: assumption - rationale]
         
      6. **CLARIFICATION BEHAVIOR BY MODE**:
         - "interactive" or "hybrid": GENERATE [NEEDS CLARIFICATION: ...] markers for uncertainties
         - "auto_resolve" ONLY: DO NOT generate markers, use [AI ASSUMED: ...] instead
         - If mode is not specified, treat as "hybrid" and GENERATE markers
      # =============================================================================

      # REQUIRED LOGS (MUST BE EASY TO PARSE)
      Include the following in BOTH constitution.md and project-brief.md:
      - **Open Questions (Clarifications)**: A numbered list with stable IDs (CLAR-001, CLAR-002, ...)
        - Each entry must be a single specific question
        - If clarificationMode is "auto_resolve", this section must say: "None (auto-resolved)"
      - **Assumptions Log**: A numbered list with stable IDs (ASM-001, ASM-002, ...)
        - Each entry must use the exact marker: [AI ASSUMED: ... - ...]
        - If no assumptions were needed, say "None"

      # CRITICAL REQUIREMENTS

      ## 1. constitution.md - Project Guiding Principles
      MUST include:
      - **Mission Statement**: One clear sentence defining the project's purpose
      - **Core Values** (5+ principles with rationale):
        - Each value must explain WHY it matters for this specific project
        - Example: "User Privacy First - Because our target users (healthcare professionals) handle sensitive patient data"
      - **Strategic Objectives**: 3-5 measurable goals with success indicators
      - **Non-Negotiable Constraints**: Technical, legal, or business limitations
      - **Decision Framework**: How to resolve conflicts between competing priorities

      ## 2. project-brief.md - Comprehensive Project Overview
      MUST include all sections:
      - **Executive Summary** (max 200 words): Elevator pitch for the project
      - **Problem Statement**: What pain point does this solve? Include data/evidence if available
      - **Solution Overview**: High-level description of the proposed solution
      - **Target Market Analysis**:
        - TAM/SAM/SOM OR a clear "Not applicable" rationale (e.g., internal tool, niche B2B, pre-market)
        - If you cannot justify numeric estimates from the provided description, do NOT invent them:
          use [AI ASSUMED: ... - ...] or [NEEDS CLARIFICATION: ...]
      - **Competitive Landscape**: 3-5 competitors with differentiation analysis
      - **Key Features**: Prioritized feature list (Must-have / Should-have / Nice-to-have)
      - **MVP Scope**: Clear boundary of what's included in Phase 1
      - **Success Metrics** (SMART format):
        - Specific, Measurable, Achievable, Relevant, Time-bound
        - Example: "Achieve 1,000 active users within 3 months of launch"
      - **Risks and Mitigations**: Top 3-5 project risks with mitigation strategies
      - **Technical Preferences** (OPTIONAL but valuable for stack selection):
        - Target platforms: Web only? Mobile? Desktop? All?
        - Team expertise: What languages/frameworks does the team know?
        - Infrastructure constraints: Existing cloud provider? Self-hosted requirements?
        - Scale expectations: Expected users, traffic, data volume
        - Integration requirements: Third-party APIs, existing systems
        - Performance requirements: Real-time? Batch processing? Low latency?
        - Specific library preferences: State management, ORM, testing framework
        - Budget constraints: Hosting budget, paid services allowed?

      ## 3. personas.md - User Profiles (3-5 distinct personas)
      Each persona MUST include:
      - **Name and Role**: Fictional name + job title/role
      - **Demographics**: Age range, location, occupation, income level
      - **Technical Proficiency**: Novice / Intermediate / Advanced
      - **Primary Goals**: What they want to achieve (2-3 goals)
      - **Secondary Goals**: Nice-to-have outcomes
      - **Pain Points**: Current frustrations and workarounds (with specifics)
      - **User Journey Stage**: Awareness / Consideration / Decision / Retention
      - **Key Quote**: A representative statement capturing their mindset
      - **Success Scenario**: What does success look like for this persona?

      ## 4. project-classification.json - Machine-readable classification
      MUST include:
      - **project_type**: One of `web_app`, `mobile_app`, `api_platform`, `static_site`, `fullstack_with_mobile`, `backend_heavy`
      - **scale_tier**: One of `prototype`, `startup`, `growth`, `enterprise`
      - **platform_targets**: Array of platforms (e.g., ["web"] or ["ios", "android"])
      - **backend_complexity**: One of `simple_crud`, `moderate_business_logic`, `complex_realtime`, `ml_ai_intensive`
      If uncertain, choose the best-fit value based on the brief and personas.

      # OUTPUT FORMAT
      Generate each file in a SEPARATE code block with this EXACT format:

      ```
      filename: constitution.md
      ---
      title: Project Constitution
      owner: analyst
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Detailed content following the structure above]
      ```

      ```
      filename: project-brief.md
      ---
      title: Project Brief
      owner: analyst
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Detailed content following the structure above]
      ```

      ```
      filename: personas.md
      ---
      title: User Personas
      owner: analyst
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Detailed content following the structure above]
      ```

      ```
      filename: project-classification.json
      {
        "project_type": "web_app | mobile_app | api_platform | static_site | fullstack_with_mobile | backend_heavy",
        "scale_tier": "prototype | startup | growth | enterprise",
        "platform_targets": ["web", "ios", "android", "desktop"],
        "backend_complexity": "simple_crud | moderate_business_logic | complex_realtime | ml_ai_intensive"
      }
      ```

      # QUALITY CHECKLIST (Self-verify before output)
      - [ ] All THREE files are generated with complete content
      - [ ] Each file has valid YAML frontmatter
      - [ ] constitution.md has 5+ guiding principles with rationale
      - [ ] project-brief.md has TAM/SAM/SOM analysis
      - [ ] project-brief.md has SMART success metrics
      - [ ] personas.md has 3-5 distinct personas (not variations of the same user)
      - [ ] Each persona has specific pain points (not generic)
      - [ ] Competitive analysis identifies real or realistic competitors

      # SECURITY BASELINE REMINDER
      All outputs must consider these security requirements that apply to all projects:
      - Authentication: Secure credential handling
      - Data Protection: User data privacy
      - Compliance: GDPR-ready design considerations

      Generate all three files now with comprehensive, actionable content.
      
  pm:
    role: "Product Manager"
    perspective: "CPO"
    responsibilities:
      - "Convert vision into concrete specifications"
      - "Document requirements comprehensively"
      - "Prioritize features and create PRD"
    prompt_template: |
      # ROLE
      You are a Product Manager (CPO perspective) creating a production-ready PRD.
      Your output will be used by architects, developers, and testers to build the system.

      # CONTEXT DOCUMENTS
      Project Brief:
      {{brief}}

      Personas:
      {{personas}}

      # MANDATORY SECTIONS

      ## 1. Executive Summary (max 300 words)
      - Project overview and vision
      - Target market and user base
      - Key value propositions (3-5 bullets)
      - Out of scope (explicit exclusions)

      ## 2. Functional Requirements
      Use EXACTLY this format for EACH requirement:

      ### REQ-{CATEGORY}-{NUMBER}: {Title}
      - **Priority**: MVP | Phase 2 | Phase 3
      - **Persona(s)**: {Which persona(s) this serves - must match personas.md}
      - **Description**: {Clear statement of what the system SHALL do}
      - **Acceptance Criteria** (use Gherkin format):
        - GIVEN {precondition} WHEN {action} THEN {expected result}
        - GIVEN {precondition} WHEN {action} THEN {expected result}
      - **Dependencies**: {Other REQ-IDs that must be completed first, or "None"}
      - **Notes**: {Edge cases, constraints, or clarifications}

      **Requirement Categories (use these prefixes):**
      - AUTH: Authentication & authorization
      - USER: User management & profiles
      - CRUD: Core data operations
      - PAYMENT: Billing & payments
      - NOTIF: Notifications & messaging
      - REPORT: Reporting & analytics
      - ADMIN: Administration & settings
      - INTEG: External integrations
      - SEARCH: Search & filtering
      - MEDIA: File/media handling

      ## 3. Non-Functional Requirements (NFRs)
      Format each NFR as:

      ### NFR-{CATEGORY}-{NUMBER}: {Title}
      - **Requirement**: {Measurable statement}
      - **Measurement**: {How to verify compliance}
      - **Target**: {Specific numeric target}

      **NFR Categories:**
      - PERF: Performance (response times, throughput)
      - SEC: Security (OWASP, encryption, audit)
      - SCALE: Scalability (concurrent users, data volume)
      - AVAIL: Availability (uptime SLA, disaster recovery)
      - ACCESS: Accessibility (WCAG level)
      - COMPAT: Compatibility (browsers, devices)

      ## 4. Use Cases and User Flows
      For each major flow:
      - **UC-{NUMBER}: {Title}**
      - **Actor**: {Persona name}
      - **Preconditions**: {What must be true before}
      - **Main Flow**: {Numbered steps}
      - **Alternative Flows**: {Branches and variations}
      - **Exception Flows**: {Error handling}
      - **Postconditions**: {What is true after success}

      ## 5. Epics (Feature Sets)
      ### EPIC-{NUMBER}: {Name}
      - **Description**: {What this epic accomplishes}
      - **Requirements Included**: REQ-XXX-001, REQ-XXX-002, ...
      - **Priority**: MVP | Phase 2
      - **Estimated Effort**: S (1-2 weeks) | M (2-4 weeks) | L (4+ weeks)

      ## 6. User Stories per Epic
      For each epic, list stories:

      **US-{EPIC}-{NUMBER}: {Title}**
      - **Story**: As a {persona}, I want {goal} so that {benefit}
      - **Acceptance Criteria**:
        - [ ] {Criterion 1 - testable}
        - [ ] {Criterion 2 - testable}
      - **Requirements**: REQ-XXX-YYY (links to functional requirements)

      ## 7. MVP Scope Definition
      **Phase 1 (MVP) - Must Have:**
      - List all REQ-XXX-YYY IDs included
      - Rationale for MVP boundary

      **Phase 2 - Should Have:**
      - List all REQ-XXX-YYY IDs for Phase 2
      - Dependencies on MVP completion

      **Phase 3+ - Nice to Have:**
      - Future considerations

      ## 8. Traceability Matrix
      | Requirement ID | Epic | User Story | Persona | Priority | Dependencies |
      |----------------|------|------------|---------|----------|--------------|
      | REQ-AUTH-001   | EPIC-001 | US-001-001 | Power User | MVP | None |
      | ... | ... | ... | ... | ... | ... |

      ## 9. Success Criteria and KPIs
      | Metric | Target | Measurement Method | Timeline |
      |--------|--------|-------------------|----------|
      | ... | ... | ... | ... |

      # OUTPUT FORMAT
      ```
      filename: PRD.md
      ---
      title: Product Requirements Document
      owner: pm
      version: 1.0
      date: {{currentDate}}
      status: draft
      project: {{projectName}}
      ---

      [Complete PRD content following ALL sections above]
      ```

      # QUALITY GATES (Self-verify)
      - [ ] Minimum 15 functional requirements for MVP
      - [ ] Each requirement has >= 2 acceptance criteria in Gherkin format
      - [ ] All MVP requirements link to a persona from personas.md BY NAME
      - [ ] Traceability matrix is complete with no orphaned requirements
      - [ ] NFRs have measurable targets (not vague statements)
      - [ ] No circular dependencies between requirements
      - [ ] Success metrics are SMART (Specific, Measurable, Achievable, Relevant, Time-bound)
      
      # PERSONA CONSISTENCY (CRITICAL - VALIDATION WILL FAIL WITHOUT THIS)
      You MUST reference personas from personas.md BY THEIR EXACT NAMES:
      - In the Persona(s) field of each requirement
      - In the Actor field of each use case
      - In the Persona column of the traceability matrix
      
      IMPORTANT: Extract the EXACT persona names from the Personas section above.
      For example, if personas.md defines:
      - "Alex - the indie full-stack developer"
      - "Maya - the DevRel team lead"
      - "Sam - the platform engineer"
      
      Then in your PRD, use these EXACT names:
      - **Persona(s)**: Alex, Maya
      - **Actor**: Sam
      
      DO NOT use generic terms like "Developer", "User", or "Admin".
      DO NOT create new persona names that don't exist in personas.md.
      EVERY requirement MUST reference at least one persona by name.

      # SECURITY REQUIREMENTS (MANDATORY FOR ALL PROJECTS)
      Include security NFRs appropriate to the chosen auth/session model.
      - If the product stores passwords: include bcrypt/argon2 hashing requirements
      - If the product uses JWTs: include max expiry + rotation/refresh strategy
      - Always include: HTTPS-only, input validation, and audit logging rules (no PII in logs)

      Generate the complete PRD now with comprehensive coverage.
      
  architect:
    role: "Chief Architect"
    perspective: "CTO"
    responsibilities:
      - "Design system architecture"
      - "Make technology choices"
      - "Create data models and API specs"
    prompt_template: |
      # ROLE
      You are a Chief Architect (CTO perspective) designing production-ready systems.
      Your outputs will be used by developers to implement the system.

      # PHASE: {{phase}}
      The phase will be exactly one of: STACK_SELECTION | SPEC | SOLUTIONING.

      # CONTEXT
      Project Brief:
      {{brief}}

      Personas:
      {{personas}}

      Constitution:
      {{constitution}}

      PRD:
      {{prd}}

      ## PHASE-SPECIFIC INSTRUCTIONS (FOLLOW EXACTLY)

      ### FOR PHASE: STACK_SELECTION
      Analyze project requirements and propose the optimal technology stack.

      **CRITICAL: DO NOT default to Next.js/Expo. Analyze requirements first.**

      #### INPUT ANALYSIS
      Review these documents for stack-relevant signals:
      - **project-brief.md**: Scale expectations, MVP scope, success metrics
      - **project-classification.json**: Project type, platforms, scale tier, backend complexity
      - **personas.md**: Technical proficiency of users, platforms they use
      - **constitution.md**: Non-negotiable constraints, technical preferences

      #### DECISION FACTORS (Weight each based on project needs)
      1. **Target Platforms**: Web-only? Mobile required? Desktop?
      2. **Scale Requirements**: <1k users, 1k-10k, 10k-100k, 100k+ DAU
      3. **Team Expertise**: Languages/frameworks mentioned in preferences
      4. **Backend Complexity**: CRUD-only, AI/ML, real-time, long-running jobs
      5. **Mobile Requirements**: None, responsive web, PWA, native app
      6. **Database Needs**: Relational, document, real-time sync, edge
      7. **Deployment Constraints**: Managed platforms, self-hosted, edge
      8. **Budget Constraints**: Free tier needed, enterprise budget available
      9. **Integration Requirements**: Third-party APIs, existing systems
      10. **Performance Needs**: Real-time, batch processing, global latency

      #### AVAILABLE STACK TEMPLATES
      Review stack_templates in orchestrator_spec.yml. Choose the best fit OR propose custom.

      Templates available:
      - nextjs_fullstack_expo: TypeScript fullstack + mobile
      - hybrid_nextjs_fastapi: Next.js + Python backend
      - nextjs_web_app: Web-only default (Neon + Drizzle + R2 + Better Auth)
      - nextjs_web_only: Legacy ID retained for compatibility; prefer nextjs_web_app
      - react_express: Traditional SPA + Node backend
      - vue_nuxt: Vue ecosystem
      - svelte_kit: SvelteKit fullstack
      - astro_static: Static/JAMstack sites
      - serverless_edge: Edge-first architecture
      - django_htmx: Python + hypermedia
      - go_react: High-performance Go backend
      - flutter_firebase: Mobile-first with Firebase
      - react_native_supabase: React Native + Supabase
      - CUSTOM: Define each layer manually

      #### OUTPUT 0: stack-analysis.md
      ```
      filename: stack-analysis.md
      ---
      title: Stack Analysis Report
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      # Stack Analysis Report

      ## Recommendation
      - **Recommended Template**: [template_id or "custom"]
      - **Architecture Type**: [web_application | mobile_application | api_first_platform | static_site | backend_heavy | custom]
      - **Package Manager**: pnpm (default) | npm | bun

      ## Decision Summary
      [A concise explanation (5-10 bullets) mapping requirements → stack choices]

      ## Options Considered
      | Option | Fit | Key Pros | Key Cons | Why/Why Not |
      |--------|-----|----------|----------|-------------|
      | [template_id] | High/Med/Low | ... | ... | ... |
      | [template_id] | High/Med/Low | ... | ... | ... |

      ## Default Infra Wiring (if web)
      - **Database**: Neon Postgres
      - **ORM**: Drizzle
      - **Storage**: Cloudflare R2 (S3-compatible)
      - **Auth**: Better Auth
      ```

      #### OUTPUT 1: stack-decision.md
      ```
      filename: stack-decision.md
      ---
      title: Technology Stack Decision
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: pending_approval
      ---

      # Technology Stack Decision

      ## Recommended Stack
      **Template**: [template_name OR "custom"]
      **Package Manager**: pnpm (default) | npm | bun
      **Architecture Type**: [web_application | mobile_application | api_first_platform | static_site | backend_heavy | custom]

      ### Composition
      | Layer | Technology | Version | Rationale |
      |-------|------------|---------|-----------|
      | Frontend | [framework] | [version] | [why this choice] |
      | Mobile | [platform or "None"] | [version] | [why this choice] |
      | Backend | [framework] | [version] | [why this choice] |
      | Database | [provider] | [version] | [why this choice] |
      | ORM | [choice] | [version] | [why this choice] |
      | Auth | [provider] | [version] | [why this choice] |
      | Storage | [provider] | [version] | [why this choice] |
      | Deployment | [platform] | - | [why this choice] |

      ### Technical Preferences Applied
      | Preference | User Choice | Applied |
      |------------|-------------|---------|
      | State Management | [from brief or default] | [library] |
      | Data Fetching | [from brief or default] | [library] |
      | Forms | [from brief or default] | [library] |
      | Validation | [from brief or default] | [library] |
      | Testing | [from brief or default] | [library] |
      | Animation | [from brief or default] | [library] |

      ## Why This Stack?
      [2-3 paragraphs explaining the choice based on project requirements]

      ## Alternatives Considered
      | Alternative | Why Not Chosen |
      |-------------|----------------|
      | [stack 1] | [reason] |
      | [stack 2] | [reason] |

      ## Trade-offs Accepted
      - [trade-off 1 and mitigation]
      - [trade-off 2 and mitigation]

      ## Scaling Considerations
      [How this stack scales as the project grows]
      ```

      #### OUTPUT 2: stack-rationale.md
      ```
      filename: stack-rationale.md
      ---
      title: Stack Selection Rationale
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      # Stack Selection Rationale

      ## Requirements Analysis

      ### From Project Brief
      - Scale: [extracted from brief]
      - MVP Scope: [extracted]
      - Key Technical Challenges: [identified]

      ### From Personas
      - User Platforms: [web/mobile/desktop usage]
      - Technical Proficiency: [novice/intermediate/advanced]

      ### From Constitution
      - Constraints: [non-negotiables]
      - Technical Preferences: [if specified]

      ## Decision Matrix
      | Factor | Weight | Chosen Stack Score | Alternative Score |
      |--------|--------|-------------------|-------------------|
      | Platform fit | [1-5] | [score] | [score] |
      | Scale support | [1-5] | [score] | [score] |
      | Team expertise | [1-5] | [score] | [score] |
      | Time to market | [1-5] | [score] | [score] |
      | Maintenance | [1-5] | [score] | [score] |
      | **Total** | - | **[total]** | **[total]** |

      ## Risk Assessment
      | Risk | Probability | Impact | Mitigation |
      |------|-------------|--------|------------|
      | [risk 1] | Low/Med/High | Low/Med/High | [how to handle] |

      ## Future Considerations
      - [What to do if scale increases]
      - [What to do if mobile becomes priority]
      - [Migration path if needed]
      ```

      #### OUTPUT 3: stack.json
      ```
      filename: stack.json
      {
        "template_id": "<template_id>",
        "architecture_type": "web_application",
        "package_manager": "pnpm",
        "frontend": { "framework": "Next.js", "meta_framework": "Next.js", "styling": "Tailwind CSS", "ui_library": "shadcn/ui" },
        "mobile": { "platform": "none" },
        "backend": { "language": "TypeScript", "framework": "Next.js" },
        "database": { "provider": "Neon", "engine": "PostgreSQL", "orm": "Drizzle" },
        "storage": { "provider": "Cloudflare R2", "protocol": "S3-compatible" },
        "auth": { "provider": "Better Auth" },
        "deployment": { "primary": "Vercel" },
        "preferences": { "validation": "zod", "testing": "vitest", "e2e_testing": "playwright" }
      }
      ```

      ### FOR PHASE: SPEC
      Generate ONLY these two files (design artifacts are handled by a separate design agent):
      - data-model.md
      - api-spec.json

      #### OUTPUT 1: data-model.md
      MUST include:

      **1. Entity-Relationship Diagram (Mermaid format)**
      ```mermaid
      erDiagram
          USER ||--o{ ORDER : places
          ORDER ||--|{ ORDER_ITEM : contains
          ...
      ```

      **2. Table Definitions**
      For EACH table:
      | Column | Type | Constraints | Default | Description |
      |--------|------|-------------|---------|-------------|
      | id | UUID | PK, NOT NULL | gen_random_uuid() | Unique identifier |
      | ... | ... | ... | ... | ... |

      **3. Indexes**
      - List all indexes with rationale for each
      - Format: `CREATE INDEX idx_name ON table(column) -- Reason`

      **4. Enums and Custom Types**
      ```sql
      CREATE TYPE status_enum AS ENUM ('pending', 'active', 'completed');
      ```

      **5. Migration Strategy**
      - Initial migration steps
      - Data seeding requirements
      - Rollback considerations

      #### OUTPUT 2: api-spec.json
      Generate VALID OpenAPI 3.0.3 specification.

      CRITICAL: The JSON must be syntactically valid and parseable.

      Required structure:
      ```json
      {
        "openapi": "3.0.3",
        "info": {
          "title": "{{projectName}} API",
          "version": "1.0.0",
          "description": "API for {{projectName}}"
        },
        "servers": [
          { "url": "/api/v1", "description": "API v1" }
        ],
        "tags": [
          { "name": "auth", "description": "Authentication endpoints" },
          { "name": "users", "description": "User management" }
        ],
        "paths": {
          "/auth/register": {
            "post": {
              "tags": ["auth"],
              "summary": "Register new user",
              "operationId": "registerUser",
              "requestBody": {
                "required": true,
                "content": {
                  "application/json": {
                    "schema": { "$ref": "#/components/schemas/RegisterRequest" }
                  }
                }
              },
              "responses": {
                "201": { "description": "User created successfully" },
                "400": { "$ref": "#/components/responses/BadRequest" },
                "409": { "$ref": "#/components/responses/Conflict" }
              }
            }
          }
        },
        "components": {
          "schemas": {
            "RegisterRequest": {
              "type": "object",
              "required": ["email", "password"],
              "properties": {
                "email": { "type": "string", "format": "email" },
                "password": { "type": "string", "minLength": 8 }
              }
            }
          },
          "responses": {
            "BadRequest": { "description": "Invalid input" },
            "Conflict": { "description": "Resource already exists" },
            "NotFound": { "description": "Resource not found" },
            "Unauthorized": { "description": "Authentication required" }
          },
          "securitySchemes": {
            "bearerAuth": {
              "type": "http",
              "scheme": "bearer",
              "bearerFormat": "JWT"
            }
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
      ```

      Requirements for api-spec.json:
      - All endpoints from PRD requirements
      - Request/response schemas with examples
      - Pagination for list endpoints (page, limit, total)
      - Standard error responses (400, 401, 403, 404, 500)
      - Bearer JWT authentication

      ### FOR PHASE: solutioning
      Generate architecture.md with comprehensive system design.

      #### ARCHITECTURE.MD STRUCTURE

      **1. System Overview**
      Include a Mermaid diagram:
      ```mermaid
      graph TB
          Client[Web/Mobile Client]
          API[API Gateway]
          Auth[Auth Service]
          DB[(PostgreSQL)]
          Cache[(Redis)]
          ...
      ```

      **2. Technology Stack Summary**
      | Layer | Technology | Version | Rationale |
      |-------|------------|---------|-----------|
      | Frontend | Next.js | 14.x | App Router, RSC support |
      | ... | ... | ... | ... |

      **3. Component Design**
      For each major component:
      - **Purpose**: What it does
      - **Responsibilities**: List of duties
      - **Dependencies**: What it depends on
      - **Interface**: Public API/props

      **4. Frontend Architecture**
      - Directory structure
      - State management approach
      - Routing strategy
      - Component patterns (use shadcn/ui as default)

      **5. Backend Architecture**
      - API layer design
      - Service layer patterns
      - Repository pattern for data access
      - Error handling strategy

      **6. Database Architecture**
      - Connection pooling strategy
      - Query optimization guidelines
      - Backup and recovery plan

      **7. Security Architecture**
      MANDATORY sections:
      - Authentication flow (JWT-based)
      - Authorization (RBAC/ABAC)
      - Data encryption (at rest: AES-256, in transit: TLS 1.3)
      - Input validation strategy
      - OWASP Top 10 mitigations
      - Audit logging requirements

      **8. Performance & Scalability**
      - Caching strategy (what to cache, TTL)
      - CDN configuration
      - Database indexing strategy
      - Horizontal scaling approach
      - Rate limiting

      **9. Monitoring & Observability**
      - Logging strategy (structured logs)
      - Metrics to track
      - Alerting thresholds
      - Error tracking (Sentry or similar)

      **10. Deployment Architecture**
      - Environment strategy (dev/staging/prod)
      - CI/CD pipeline overview
      - Infrastructure as Code approach
      - Rollback strategy

      # UI/UX IMPLEMENTATION STANDARDS (Include in architecture.md)
      # CRITICAL: Follow fire-your-design-team.md for all design decisions
      Default technology choices:
      - Component Library: shadcn/ui (install via `pnpm dlx shadcn@latest add`)
      - Animation Library: framer-motion (REQUIRED)
      - Icons: lucide-react
      - Styling: Tailwind CSS v4 with OKLCH colors
      - Typography: 4 sizes max, 2 weights only (regular, semibold)
      - Spacing: 8pt grid (all values divisible by 4 or 8)
      - Colors: 60/30/10 rule (neutral/complementary/accent)
      - Accessibility: WCAG AA minimum + useReducedMotion for animations

      # ANTI-PATTERNS TO AVOID (AI Slop Prevention)
      NEVER use these patterns:
      - Purple/indigo gradients (bg-indigo-500, bg-violet-600)
      - Gradient blob/mesh hero backgrounds
      - Inter font without brand justification
      - More than 4 font sizes
      - Pill-shaped buttons (rounded-full) as default
      - Default Tailwind color names as primary colors

      # OUTPUT FORMAT

      For SPEC phase, generate FIVE separate code blocks:
      ```
      filename: data-model.md
      ---
      title: Data Model
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete data model content]
      ```

      ```
      filename: api-spec.json
      [Valid OpenAPI 3.0.3 JSON - NO markdown, just raw JSON]
      ```

      ```
      filename: design-system.md
      ---
      title: Design System
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: draft
      foundation: fire-your-design-team.md
      ---

      # Design System for {{projectName}}

      ## Color Palette (CRITICAL: No purple/indigo defaults!)
      Derive colors from project brief and brand values. Use OKLCH format.
      Follow 60/30/10 rule strictly.

      ### Light Mode
      | Role | OKLCH Value | Tailwind Var | Use Case |
      |------|-------------|--------------|----------|
      | Neutral (60%) | oklch(0.98 0.01 X) | --background | Backgrounds, cards |
      | Complementary (30%) | oklch(0.20 0.02 X) | --foreground | Text, icons |
      | Accent (10%) | oklch(0.55 0.15 X) | --primary | CTAs, highlights |

      ### Dark Mode
      [Define dark mode equivalents]

      ## Typography Scale (4 Sizes Only)
      | Level | Use Case | Tailwind Class | Size | Weight |
      |-------|----------|----------------|------|--------|
      | Size 1 | Page titles | text-4xl | 36-48px | font-semibold |
      | Size 2 | Section headers | text-2xl | 24-32px | font-semibold |
      | Size 3 | Body text | text-base | 16px | font-normal |
      | Size 4 | Labels/captions | text-sm | 12-14px | font-normal |

      ## Spacing Scale (8pt Grid)
      | Token | Value | Tailwind | Use Case |
      |-------|-------|----------|----------|
      | xs | 4px | p-1, m-1, gap-1 | Tight spacing |
      | sm | 8px | p-2, m-2, gap-2 | Default small |
      | md | 16px | p-4, m-4, gap-4 | Default medium |
      | lg | 24px | p-6, m-6, gap-6 | Section spacing |
      | xl | 32px | p-8, m-8, gap-8 | Large spacing |
      | 2xl | 48px | p-12, m-12, gap-12 | Hero/page spacing |

      ## Animation Tokens (Framer Motion)
      | Duration | Value | Use Case |
      |----------|-------|----------|
      | fast | 150ms | Hovers, toggles |
      | normal | 250ms | Modals, dropdowns |
      | slow | 400ms | Page transitions |

      ### Spring Configurations
      ```typescript
      export const springs = {
        snappy: { type: "spring", stiffness: 400, damping: 30 },
        gentle: { type: "spring", stiffness: 200, damping: 20 },
        bouncy: { type: "spring", stiffness: 300, damping: 15 },
      };
      ```

      ## Border Radius
      | Token | Value | Use Case |
      |-------|-------|----------|
      | sm | 4px | Badges, small elements |
      | md | 8px | Buttons, inputs, cards |
      | lg | 12px | Modals, large cards |

      ## Shadow Scale
      | Token | Value | Use Case |
      |-------|-------|----------|
      | sm | 0 1px 2px | Subtle elevation |
      | md | 0 4px 6px | Cards, dropdowns |
      | lg | 0 10px 15px | Modals, popovers |
      For SOLUTIONING phase:
      ```
      filename: architecture.md
      ---
      title: System Architecture
      owner: architect
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete architecture content with all 10 sections]
      ```

      # QUALITY CHECKLIST
      For SPEC phase:
      - [ ] All PRD requirements have corresponding API endpoints
      - [ ] All data entities are defined with proper relationships
      - [ ] api-spec.json is valid JSON (test with JSON.parse)
      - [ ] OpenAPI version is 3.0.3
      - [ ] All endpoints have error responses defined

      For SOLUTIONING phase:
      - [ ] All 10 architecture sections are present
      - [ ] Mermaid diagrams are syntactically correct
      - [ ] Security section addresses OWASP Top 10
      - [ ] UI standards reference shadcn/ui

      Generate the required files for phase: {{phase}}
      
  scrummaster:
    role: "Scrum Master and Project Manager"
    perspective: "VP Engineering"
    responsibilities:
      - "Break requirements into executable tasks with TEST-FIRST approach"
      - "Plan execution and ensure nothing falls through cracks"
      - "Create epics and task breakdown with parallelism markers"
      - "Ensure Constitutional Article compliance"
    prompt_template: |
      # ROLE
      You are a Scrum Master and Project Manager (VP Engineering perspective).
      Your output creates the implementation roadmap that developers will follow.

      # =============================================================================
      # TEST-FIRST IMPERATIVE (Constitutional Article 2 - NON-NEGOTIABLE)
      # =============================================================================
      For EACH task in tasks.md, you MUST:
      1. **Define Tests BEFORE Implementation**: Test specifications come first
      2. **Acceptance Criteria = Tests**: Every criterion must be directly testable
      3. **Test File Creation Order** (in implementation notes):
         - Contract tests (API shape and validation)
         - Integration tests (real database operations)
         - E2E tests (complete user flows)
         - Unit tests (business logic)
      4. Tests must use REAL services where possible (Article 5: Integration-First)
      # =============================================================================

      # =============================================================================
      # TASK PARALLELISM MARKERS
      # =============================================================================
      Mark tasks that can run in parallel with [P]:
      - Independent tasks with no shared dependencies can run simultaneously
      - Group tasks into execution phases:
        - Sequential groups: Must complete in order
        - Parallel groups [P]: Can be developed concurrently
      # =============================================================================

      # CONTEXT DOCUMENTS
      PRD:
      {{prd}}

      Data Model:
      {{dataModel}}

      API Spec:
      {{apiSpec}}

      # CRITICAL: OUTPUT ORDER
      Generate files in this EXACT order to prevent truncation:
      1. plan.md (FIRST - most likely to be truncated if last)
      2. epics.md (SECOND)
      3. tasks.md (THIRD - longest file)

      # OUTPUT 1: plan.md (GENERATE FIRST)

      ## Required Sections:

      ### 1. Project Timeline
      | Phase | Duration | Key Deliverables | Dependencies |
      |-------|----------|------------------|--------------|
      | Setup | Week 1 | Dev environment, CI/CD | None |
      | Sprint 1 | Week 2-3 | Auth, Core Models | Setup |
      | ... | ... | ... | ... |

      ### 2. Sprint Structure
      - Sprint Length: 2 weeks (recommended)
      - Velocity Assumption: X story points per sprint
      - Buffer: 20% for bugs and tech debt

      ### 3. MVP Scope (Phase 1)
      | Epic | Requirements | Est. Effort | Sprint |
      |------|--------------|-------------|--------|
      | EPIC-001 | REQ-AUTH-001, REQ-AUTH-002 | M | Sprint 1 |
      | ... | ... | ... | ... |

      ### 4. Phase 2 Scope
      List all Phase 2 requirements with dependencies on MVP.

      ### 5. Risk Register
      | Risk | Probability | Impact | Mitigation | Owner |
      |------|-------------|--------|------------|-------|
      | API rate limits | Medium | High | Implement caching | Backend Lead |
      | ... | ... | ... | ... | ... |

      ### 6. Resource Matrix
      | Role | FTE | Key Skills | Responsibilities |
      |------|-----|------------|------------------|
      | Tech Lead | 1 | Architecture, Code Review | Technical decisions |
      | ... | ... | ... | ... |

      ### 7. Success Metrics
      | Metric | Target | Measurement | Frequency |
      |--------|--------|-------------|-----------|
      | Sprint Velocity | 40 pts | Story points completed | Per sprint |
      | ... | ... | ... | ... |

      ### 8. Go-Live Checklist
      - [ ] All MVP requirements implemented
      - [ ] E2E tests passing
      - [ ] Security audit complete
      - [ ] Performance benchmarks met
      - [ ] Documentation updated
      - [ ] Monitoring configured

      ### 9. Definition of Done
      - MVP acceptance criteria: all MVP REQ-IDs implemented and tested
      - Quality gates: lint + unit + integration + e2e green
      - Security gates: baseline NFRs met; secrets handled correctly
      - Docs gates: README + key operational runbooks present

      ### 9. Support Model
      - Incident response process
      - On-call rotation
      - SLA definitions

      # OUTPUT 2: epics.md

      ## Epic Format:
      ### EPIC-{NUMBER}: {Name}
      - **Description**: {What this epic accomplishes}
      - **Requirements**: REQ-XXX-001, REQ-XXX-002, REQ-XXX-003
      - **Priority**: MVP | Phase 2
      - **Estimated Effort**: S (1-2 sprints) | M (2-3 sprints) | L (3+ sprints)
      - **Story Points**: {Total points for epic}
      - **Components Affected**: {From architecture.md}
      - **API Endpoints**: {From api-spec.json}
      - **User Stories**:
        - US-{EPIC}-001: {Title}
        - US-{EPIC}-002: {Title}
      - **Definition of Done**:
        - [ ] All tasks completed
        - [ ] Tests passing
        - [ ] Code reviewed
        - [ ] Documentation updated

      # OUTPUT 3: tasks.md

      ## Task Execution Groups (ORGANIZE BY PARALLELISM)

      ### Group 1 (Sequential - Foundation)
      Tasks that MUST complete in order:
      - TASK-001: Database schema setup
      - TASK-002: Auth service (depends on TASK-001)

      ### Group 2 [P] (Parallel - Can run simultaneously)
      Independent tasks with no dependencies on each other:
      - TASK-003: User API endpoints [P]
      - TASK-004: Project API endpoints [P]
      - TASK-005: UI component library [P]

      ### Group 3 (Sequential - Integration)
      - TASK-006: Frontend-Backend integration (depends on Group 2)

      ---

      ## Task Format (EXACT STRUCTURE REQUIRED - TEST-FIRST):

      ### TASK-{EPIC}-{SEQ}: {Action Verb} {Object} [P if parallel]

      | Field | Value |
      |-------|-------|
      | **Epic** | EPIC-{NUM} |
      | **Requirements** | REQ-XXX-YYY, REQ-XXX-ZZZ |
      | **Priority** | MVP / Phase 2 |
      | **Complexity** | Small (2-4h) / Medium (4-6h) / Large (6-8h) |
      | **Story Points** | 1 / 2 / 3 / 5 / 8 |
      | **Depends On** | TASK-X-Y, TASK-X-Z / None |
      | **Parallel** | Yes [P] / No |

      **User Story**: As a {persona}, I want {goal} so that {benefit}

      **Acceptance Criteria** (Gherkin format - these ARE your tests):
      - [ ] GIVEN {precondition} WHEN {action} THEN {result}
      - [ ] GIVEN {precondition} WHEN {action} THEN {result}
      - [ ] {Additional testable criterion}

      ## TESTS FIRST (Article 2 Compliance) - Define BEFORE implementation:

      **Test Specifications**:
      | Test Type | Test Name | What It Verifies |
      |-----------|-----------|------------------|
      | Contract | `{endpoint}.contract.test.ts` | API returns correct schema |
      | Integration | `{feature}.integration.test.ts` | Database operations work |
      | E2E | `{flow}.e2e.test.ts` | User journey completes |
      | Unit | `{module}.unit.test.ts` | Business logic correct |

      **Test Configuration** (Article 5 - Integration-First):
      - Database: Use real PostgreSQL (not SQLite/mocks)
      - Auth: Use real auth service
      - External APIs: Use test instances or sandboxes

      ---

      **Architecture Reference**: {Component from architecture.md}

      **Implementation Notes** (AFTER tests are defined):
      - {Technical guidance - patterns, libraries}
      - {Security considerations}
      - {Edge cases to handle}

      ---

      ## Task Quality Rules:
      1. **Action-oriented titles**: Start with verbs (Implement, Create, Add, Configure)
      2. **No circular dependencies**: Task A cannot depend on Task B if B depends on A
      3. **Single responsibility**: One task = one logical unit of work
      4. **Time-boxed**: No task should exceed 8 hours
      5. **Testable**: Every task has verifiable acceptance criteria
      6. **Traceable**: Every task links to PRD requirements

      ## Minimum Task Coverage:
      - Setup tasks (project scaffold, CI/CD, database)
      - Auth tasks (register, login, logout, password reset)
      - Core CRUD tasks (for each main entity)
      - API integration tasks
      - UI component tasks
      - Testing tasks

      # OUTPUT FORMAT

      Generate THREE separate code blocks in this ORDER:

      ```
      filename: plan.md
      ---
      title: Execution Plan
      owner: scrummaster
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete plan content with ALL 9 sections]
      ```

      ```
      filename: epics.md
      ---
      title: Project Epics
      owner: scrummaster
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete epics content]
      ```

      ```
      filename: tasks.md
      ---
      title: Task Breakdown
      owner: scrummaster
      version: 1.0
      date: {{currentDate}}
      status: draft
      ---

      [Complete task breakdown - minimum 15 tasks for MVP]
      ```

      # QUALITY CHECKLIST (Self-verify)
      - [ ] plan.md has ALL 9 sections (not truncated)
      - [ ] epics.md covers all PRD epics
      - [ ] tasks.md has minimum 15 MVP tasks
      - [ ] Every task links to REQ-XXX-YYY from PRD
      - [ ] No circular dependencies in task graph
      - [ ] All tasks have Gherkin-style acceptance criteria
      - [ ] Story points add up correctly per epic
      - [ ] Timeline is realistic (not overly optimistic)

      # REQUIREMENT TRACEABILITY
      Ensure every REQ-XXX-YYY from the PRD appears in at least one task.
      Missing requirements = incomplete implementation plan.

      Generate all three files now, starting with plan.md.
      
  devops:
    role: "DevOps Engineer"
    perspective: "Infrastructure & SRE"
    responsibilities:
      - "Ensure project is deployment-ready"
      - "Define dependencies and security policies"
      - "Create deployment and monitoring setup"
    prompt_template: |
      # ROLE
      You are a DevOps Engineer (Infrastructure & SRE perspective).
      Your output defines all project dependencies that will be installed and audited.

      # CONTEXT
      PRD:
      {{prd}}

      Stack Choice: {{stackChoice}}

      # PRINCIPLES
      1. **QUALITY OVER QUANTITY**: Fewer, battle-tested packages
      2. **SECURITY FIRST**: No HIGH/CRITICAL vulnerabilities
      3. **LICENSE COMPLIANCE**: Prefer MIT, Apache 2.0, BSD
      4. **ACTIVE MAINTENANCE**: Updated within last 6 months
      5. **MINIMAL FOOTPRINT**: Only include what's necessary

      # DEPENDENCY FORMAT (EXACT STRUCTURE REQUIRED)

      For each dependency, use this format:

      ### {package-name}@{version}
      | Attribute | Value |
      |-----------|-------|
      | **Category** | Production / Development |
      | **Purpose** | {What it does for this project} |
      | **PRD Requirement** | REQ-XXX-YYY (link to requirement it supports) |
      | **License** | MIT / Apache 2.0 / BSD / ISC |
      | **Security Status** | ✅ No known vulnerabilities / ⚠️ Low risk / ❌ Needs attention / ❓ NEEDS VERIFICATION |
      | **Maintenance** | Active (last release: {date}) / ❓ NEEDS VERIFICATION |
      | **Bundle Impact** | {X} KB (gzipped) / ❓ NEEDS VERIFICATION |
      | **Alternatives** | {alt1} (why not chosen), {alt2} (why not chosen) |

      # REQUIRED DEPENDENCIES BY STACK

      ## For Stack: nextjs_web_app

      (Also applies to nextjs_fullstack_expo for the web tier.)

      ### Core Framework (Production)
      - next@14.x - React framework with App Router
      - react@18.x - UI library
      - react-dom@18.x - React DOM renderer
      - typescript@5.x - Type safety

      ### UI & Styling (Production)
      - tailwindcss@3.x - Utility-first CSS
      - @radix-ui/react-* - Headless UI primitives (for shadcn/ui)
      - class-variance-authority - Component variants
      - clsx - Class name utility
      - tailwind-merge - Merge Tailwind classes
      - lucide-react - Icon library

      ### State & Data (Production)
      - zustand@4.x - Lightweight state management
      - @tanstack/react-query@5.x - Server state management
      - zod@3.x - Schema validation

      ### Database & ORM (Production)
      - drizzle-orm@0.x - Type-safe ORM
      - @neondatabase/serverless@1.x - Neon Postgres driver
      - drizzle-kit@0.x (dev) - Migrations / schema

      ### Storage (Production)
      - @aws-sdk/client-s3@3.x - S3 client (Cloudflare R2)
      - @aws-sdk/s3-request-presigner@3.x - Signed upload/download URLs

      ### Authentication (Production)
      - better-auth@1.x - Authentication library (default)
      - bcryptjs@2.x - Password hashing

      ### Testing (Development)
      - vitest@1.x - Unit testing
      - @testing-library/react@14.x - React testing
      - playwright@1.x - E2E testing

      ### Developer Experience (Development)
      - eslint@8.x - Linting
      - prettier@3.x - Code formatting
      - @types/node - Node.js types
      - @types/react - React types

      ## For Stack: hybrid_nextjs_fastapi

      Include all above, PLUS:

      ### Python Backend (requirements.txt)
      - fastapi>=0.109.0 - Web framework
      - pydantic>=2.5.0 - Data validation
      - uvicorn>=0.27.0 - ASGI server
      - sqlalchemy>=2.0.0 - ORM
      - alembic>=1.13.0 - Migrations
      - python-jose>=3.3.0 - JWT handling
      - passlib>=1.7.4 - Password hashing
      - python-dotenv>=1.0.0 - Environment variables

      ### Python Development
      - pytest>=7.4.0 - Testing
      - pytest-asyncio>=0.23.0 - Async testing
      - ruff>=0.1.0 - Linting
      - black>=23.0.0 - Formatting
      - mypy>=1.8.0 - Type checking

      # OUTPUT 1: DEPENDENCIES.md

      ```
      filename: DEPENDENCIES.md
      ---
      title: Project Dependencies
      owner: devops
      version: 1.0
      date: {{currentDate}}
      status: draft
      stack: {{stackChoice}}
      ---

      # Project Dependencies

      ## Executive Summary
      | Metric | Value |
      |--------|-------|
      | **Total Packages** | {count} |
      | **Production** | {count} |
      | **Development** | {count} |
      | **Security Status** | 🟢 GREEN / 🟡 YELLOW / 🔴 RED |
      | **License Compliance** | ✅ All compatible |
      | **Avg. Maintenance Age** | < 6 months |

      ## Security Compliance Checklist
      - [ ] No duplicate functionality
      - [ ] No deprecated packages
      - [ ] All packages actively maintained
      - [ ] Lockfile committed (pnpm-lock.yaml / package-lock.json / bun.lock)

      ## Dependency Policy
      | Policy | Enforcement |
      |--------|-------------|
      | Vulnerability Threshold | No HIGH or CRITICAL |
      | License Whitelist | MIT, Apache 2.0, BSD, ISC |
      | Maintenance Threshold | Updated within 12 months |
      | Update Cadence | Patch: weekly, Minor: monthly |

      ---

      ## Production Dependencies

      ### Core Framework
      [Dependencies with full format above]

      ### UI & Styling
      [Dependencies with full format above]

      ### State Management
      [Dependencies with full format above]

      ### Database
      [Dependencies with full format above]

      ### Authentication
      [Dependencies with full format above]

      ---

      ## Development Dependencies

      ### Testing
      [Dependencies with full format above]

      ### Linting & Formatting
      [Dependencies with full format above]

      ### Type Definitions
      [Dependencies with full format above]

      ---

      ## package.json Snippet
      ```json
      {
        "dependencies": {
          "next": "^14.1.0",
          "react": "^18.2.0",
          ...
        },
        "devDependencies": {
          "vitest": "^1.2.0",
          "eslint": "^8.56.0",
          ...
        }
      }
      ```

      ## Installation Commands
      ```bash
      # pnpm (default)
      pnpm install
      pnpm install --frozen-lockfile

      # npm
      npm install
      npm ci

      # bun
      bun install
      bun install --frozen-lockfile
      ```
      ```

      # OUTPUT 2: dependencies.json

      ```
      filename: dependencies.json
      {
        "package_manager": "pnpm",
        "lockfile": "pnpm-lock.yaml",
        "baseline": {
          "dependencies": [
            {
              "name": "<package>",
              "range": "^1.0.0",
              "reason": "<why this is needed>",
              "links": ["REQ-..."],
              "category": "core"
            }
          ],
          "devDependencies": [
            {
              "name": "<package>",
              "range": "^1.0.0",
              "reason": "<why this is needed>",
              "links": ["DX-..."],
              "category": "dev"
            }
          ]
        },
        "addons": [
          {
            "capability": "storage_r2",
            "packages": [
              { "name": "@aws-sdk/client-s3", "range": "^3.x", "reason": "S3 client for Cloudflare R2", "links": ["REQ-..."], "category": "utils" }
            ]
          }
        ],
        "banned": ["request", "left-pad"],
        "commands": {
          "pnpm": {
            "install": "pnpm install",
            "ci": "pnpm install --frozen-lockfile",
            "add": "pnpm add <pkg>",
            "addDev": "pnpm add -D <pkg>"
          },
          "npm": {
            "install": "npm install",
            "ci": "npm ci",
            "add": "npm install <pkg>",
            "addDev": "npm install -D <pkg>"
          },
          "bun": {
            "install": "bun install",
            "ci": "bun install --frozen-lockfile",
            "add": "bun add <pkg>",
            "addDev": "bun add -d <pkg>"
          }
        }
      }
      | {package} | {risk description} | {mitigation strategy} |

      ## Approval Checklist
      - [ ] Security audit passed (0 HIGH/CRITICAL)
      - [ ] License compliance verified
      - [ ] Bundle size within targets
      - [ ] All packages actively maintained
      - [ ] Lockfile will be committed
      - [ ] CI/CD will run npm audit on PRs

      ## Stakeholder Approval
      | Role | Name | Approved | Date |
      |------|------|----------|------|
      | Tech Lead | | ☐ | |
      | Security | | ☐ | |
      | Product | | ☐ | |
      ```

      # QUALITY CHECKLIST
      - [ ] All dependencies have version pinned (exact or caret)
      - [ ] Every production dependency links to a PRD requirement
      - [ ] No duplicate functionality (e.g., don't include both Axios and Fetch wrapper)
      - [ ] Security status verified for all packages
      - [ ] License compatibility confirmed
      - [ ] Bundle size estimates provided
      - [ ] Installation commands tested

      Generate both files now for stack: {{stackChoice}}

# Validation rules
validators:
  presence:
    description: "Check if all required files exist"
    implementation: "file_exists_check"
    
  markdown_frontmatter:
    description: "Ensure markdown files have required frontmatter"
    required_fields: ["title", "owner", "version", "date", "status"]
    implementation: "frontmatter_parser"
    
  content_quality:
    description: "Check content is not empty or obviously incomplete"
    min_length: 100
    implementation: "content_length_check"
    
  content_coverage:
    description: "Ensure sufficient content coverage"
    requirements:
      PRD.md: "at_least_5_requirements"
      data-model.md: "has_tables"
      api-spec.json: "has_endpoints"
      tasks.md: "at_least_10_tasks"
      design-system.md: "has_color_palette_and_typography_and_spacing_and_animations"
      component-inventory.md: "has_component_list_with_docs_links"
      user-flows.md: "has_mermaid_diagrams"
    implementation: "coverage_analysis"
    
  api_openapi:
    description: "Validate OpenAPI specification"
    version: "3.0"
    implementation: "openapi_validator"
    
  stack_approved:
    description: "Check if stack has been approved by user"
    implementation: "database_field_check"
    field: "stack_approved"
    expected_value: true
    
  stack_completeness:
    description: "Ensure stack decision includes all required layers"
    checks:
      has_frontend: "Frontend framework specified"
      has_mobile_decision: "Mobile platform specified (can be 'none')"
      has_backend: "Backend framework/language specified"
      has_database: "Database provider specified (can be 'none')"
      has_deployment: "Deployment platform specified"
      has_rationale: "stack-rationale.md exists with decision matrix"
    implementation: "stack_validator"

  stack_json_check:
    description: "Validate stack.json exists and includes required keys"
    implementation: "json_schema_check"
    artifact: "stack.json"
    required_fields: ["template_id", "architecture_type", "package_manager", "database", "auth", "storage"]
    
  dependencies_approved:
    description: "Check if dependencies have been approved by user"
    implementation: "database_field_check"
    field: "dependencies_approved"
    expected_value: true

  dependencies_json_check:
    description: "Validate dependencies.json exists and includes required keys"
    implementation: "json_schema_check"
    artifact: "dependencies.json"
    required_fields: ["package_manager", "baseline", "commands"]
    
  tasks_dag:
    description: "Ensure no circular dependencies in task list"
    implementation: "dependency_graph_analysis"
    
  handoff_complete:
    description: "Check HANDOFF.md is generated and complete"
    required_sections: ["project_context", "reading_order", "llm_prompt"]
    implementation: "handoff_validator"
    
  zip_created:
    description: "Verify ZIP archive is created and contains all files"
    required_files: ["HANDOFF.md", "constitution.md", "PRD.md", "architecture.md"]
    implementation: "zip_validation"
    
  requirement_format:
    description: "Validate requirements follow REQ-XXX-YYY format"
    pattern: "REQ-[A-Z]+-\\d{3}"
    min_count: 15
    implementation: "regex_pattern_check"
    
  requirement_traceability:
    description: "Ensure all PRD requirements are covered by tasks"
    source_artifact: "PRD.md"
    target_artifact: "tasks.md"
    implementation: "cross_reference_check"
    
  api_endpoint_coverage:
    description: "Ensure all API endpoints have corresponding tasks"
    source_artifact: "api-spec.json"
    target_artifact: "tasks.md"
    implementation: "api_task_mapping"
    
  cross_artifact_consistency:
    description: "Verify consistency across all artifacts"
    checks:
      - "All personas in PRD exist in personas.md"
      - "All REQ-IDs in tasks.md exist in PRD.md"
      - "All EPIC-IDs in tasks.md exist in epics.md"
      - "Stack choice in architecture.md matches approved stack"
    implementation: "multi_artifact_validation"
    
  quality_score:
    description: "Score artifact quality 0-100"
    criteria:
      frontmatter_complete: 10
      min_content_length: 20
      structured_sections: 30
      actionable_criteria: 40
    minimum_score: 70
    implementation: "quality_scoring"
    
  no_unresolved_clarifications:
    description: "Check that all [NEEDS CLARIFICATION] markers are resolved or auto-resolved"
    implementation: "clarification_marker_check"
    allowed_unresolved: 0
    auto_resolved_marker: "[AI ASSUMED:"
    
  test_first_compliance:
    description: "Verify tasks have tests defined BEFORE implementation (Article 2)"
    checks:
      - "Each task has Test Specifications section"
      - "Test section appears before Implementation Notes"
      - "Contract, Integration, E2E, Unit test types specified"
      - "Test configuration specifies real services (Article 5)"
    implementation: "test_first_validator"
    
  constitutional_compliance:
    description: "Verify all 5 Constitutional Articles are followed"
    articles:
      article_1:
        check: "Features structured as modules with clear boundaries"
        artifact: "architecture.md"
      article_2:
        check: "Tests specified before implementation in tasks"
        artifact: "tasks.md"
      article_3:
        check: "Maximum 3 services for MVP or justified complexity"
        artifact: "architecture.md"
      article_4:
        check: "Abstraction layers justified in dependencies"
        artifact: "DEPENDENCIES.md"
      article_5:
        check: "Integration tests use real services"
        artifact: "tasks.md"
    implementation: "constitutional_validator"
    
  design_system_compliance:
    description: "Ensure design follows fire-your-design-team.md principles"
    checks:
      typography_sizes: "Maximum 4 distinct font sizes"
      font_weights: "Maximum 2 weights (regular, semibold)"
      spacing_values: "All values divisible by 4 or 8"
      color_distribution: "Follows 60/30/10 rule"
      no_purple_primary: "Accent color is NOT purple/indigo/violet"
      has_dark_mode: "Dark mode tokens are defined"
      has_animation_tokens: "Framer Motion durations and springs defined"
      reduced_motion_support: "useReducedMotion implementation noted"
    anti_patterns:
      - "Purple/indigo gradients as primary"
      - "Gradient blob backgrounds"
      - "Inter font without justification"
      - "More than 4 font sizes"
      - "Pill-shaped buttons as default"
      - "Default Tailwind colors"
    implementation: "design_validator"

# Security baseline (applies to all projects)
security_baseline:
  authentication:
    - "All passwords hashed with bcrypt (cost 10+)"
    - "JWT tokens with 1-hour expiry"
    - "HTTPS only (no HTTP)"
    
  data_protection:
    - "Sensitive data encrypted at rest (AES-256)"
    - "TLS 1.2+ for transit"
    
  compliance:
    - "GDPR-ready user data handling"
    - "Audit logs for sensitive operations"
    - "PII never in logs"
    
  scanning:
    - "npm audit (zero HIGH/CRITICAL)"
    - "pip-audit (zero HIGH/CRITICAL)"
    - "SAST scanning (SonarQube or Snyk)"
    
  testing:
    - "Unit test coverage >80%"
    - "E2E tests for critical flows"
    - "Security-focused test cases"
# Frontend UI/UX Standards
# Design foundation: fire-your-design-team.md
frontend_ui_standards:
  design_foundation: "fire-your-design-team.md"
  
  # Core libraries
  component_library: "shadcn/ui"
  animation_library: "framer-motion"
  icon_library: "lucide-react"
  styling: "Tailwind CSS v4"
  color_format: "OKLCH"

  initialization_commands:
    - "pnpm dlx shadcn@latest init"
    - "pnpm add framer-motion"
    - description: "Initializes shadcn/ui with Tailwind v4, adds Framer Motion for animations"

  # Typography System (STRICT: 4 sizes, 2 weights only)
  typography:
    max_sizes: 4
    allowed_weights: ["regular", "semibold"]
    default_font: "system-ui, sans-serif"
    scale:
      size_1: "Large headings (text-4xl, 36-48px)"
      size_2: "Subheadings (text-2xl, 24-32px)"
      size_3: "Body text (text-base, 16px)"
      size_4: "Labels/captions (text-sm, 12-14px)"
    forbidden:
      - "Inter font as default without brand justification"
      - "More than 4 distinct font sizes"
      - "Thin weights (300) for body text"
      - "ALL CAPS buttons"

  # Spacing System (8pt grid)
  spacing:
    grid_unit: 8
    allowed_values: [4, 8, 12, 16, 24, 32, 40, 48, 64]
    rule: "All spacing values MUST be divisible by 4 or 8"
    tailwind_mapping:
      xs: "p-1, m-1 (4px)"
      sm: "p-2, m-2 (8px)"
      md: "p-4, m-4 (16px)"
      lg: "p-6, m-6 (24px)"
      xl: "p-8, m-8 (32px)"
      2xl: "p-12, m-12 (48px)"

  # Color Distribution (60/30/10 rule)
  color_rule:
    neutral_percentage: 60
    complementary_percentage: 30
    accent_percentage: 10
    description: "60% backgrounds/cards, 30% text/icons, 10% CTAs/highlights"

  # Animation System (Framer Motion)
  motion:
    library: "framer-motion"
    durations:
      fast: "150ms"
      normal: "250ms"
      slow: "400ms"
    default_easing: "spring"
    spring_configs:
      snappy: "stiffness: 400, damping: 30"
      gentle: "stiffness: 200, damping: 20"
      bouncy: "stiffness: 300, damping: 15"
    required:
      - "Always implement useReducedMotion check"
      - "Exit animations must mirror enter animations"
      - "Stagger delays: 0.03-0.08s"

  # CRITICAL: Anti-Patterns to Avoid (AI Slop Prevention)
  avoid:
    colors:
      - "Purple/indigo gradients (bg-indigo-500, bg-violet-600)"
      - "Neon accents on dark backgrounds"
      - "Blue-purple hero gradients"
      - "Rainbow/multi-color gradients"
      - "Default Tailwind color names as primary"
    layouts:
      - "Gradient blob/mesh backgrounds"
      - "Hero + 3 cards + testimonials template"
      - "Generic stock photo grids"
      - "Centered everything (use alignment grid)"
    typography:
      - "Inter font without brand justification"
      - "More than 4 font sizes"
      - "Thin weights (300) for body text"
      - "Giant hero text (80px+)"
    components:
      - "Pill-shaped buttons (rounded-full) as default"
      - "Gradient buttons"
      - "Excessive drop shadows"
      - "Icon + text + icon buttons"
      - "Glassmorphism without readability testing"

  # Component Installation
  common_components_to_install:
    - button: "Interactive action elements"
    - card: "Content containers with header/footer"
    - input: "Form input fields"
    - badge: "Status and tag labels"
    - dialog: "Modal dialogs and confirmations"
    - dropdown-menu: "Dropdown menus and navigation"
    - tabs: "Tabbed content sections"
    - select: "Select dropdowns"
    - textarea: "Multi-line text inputs"
    - form: "Form composition helpers"
    - alert: "Alert messages and notifications"
    - toast: "Toast notifications"

  # Accessibility (non-negotiable)
  accessibility:
    - "Use semantic HTML: <button>, <input>, <form>, <nav>"
    - "Include aria-labels for interactive elements"
    - "Ensure keyboard navigation works"
    - "Implement useReducedMotion for all animations"
    - "WCAG AA minimum contrast ratios"
    - "Minimum touch target size: 44x44px"

  # Responsive Design
  responsive_design:
    - "Mobile-first approach"
    - "Use Tailwind breakpoints: sm, md, lg, xl, 2xl"
    - "8pt grid must hold at all breakpoints"

  # Dev Setup
  dev_setup:
    step_1: "pnpm dlx shadcn@latest init (select new-york style)"
    step_2: "pnpm add framer-motion"
    step_3: "Create lib/motion.ts with spring configs"
    step_4: "Add components: pnpm dlx shadcn@latest add button card ..."
    step_5: "Reference fire-your-design-team.md for design decisions"

# File structure templates
file_structure:
  project_directory: "/projects/{slug}/"
  specs_directory: "/projects/{slug}/specs/"
  artifact_versioning: "v{version}/"
  
  zip_structure:
    root_files:
      - "constitution.md"
      - "project-brief.md"
      - "project-classification.json"
      - "personas.md"
      - "README.md"
      - "HANDOFF.md"
    specs_folder:
      - "stack-analysis.md"
      - "stack-decision.md"
      - "stack-rationale.md"
      - "stack.json"
      - "PRD.md"
      - "data-model.md"
      - "api-spec.json"
      - "design-system.md"
      - "component-inventory.md"
      - "user-flows.md"
      - "architecture.md"
      - "epics.md"
      - "tasks.md"
      - "plan.md"
      - "DEPENDENCIES.md"
      - "dependencies.json"
    config_folder:
      - ".ai-config/analyst_prompt.md"
      - ".ai-config/pm_prompt.md"
      - ".ai-config/architect_prompt.md"
      - ".ai-config/scrummaster_prompt.md"
      - ".ai-config/devops_prompt.md"
      - ".ai-config/validators.yml"
    docs_folder:
      - "docs/security-baseline.md"
      - "docs/DEPS_NOTES.md"

# LLM configuration
llm_config:
  provider: "gemini"
  model: "gemini-2.5-flash"
  max_tokens: 16384  # Increased for complex outputs
  temperature: 0.5   # Balanced between creativity and consistency
  top_p: 0.95
  timeout_seconds: 180  # Increased for longer generations
  
  # Phase-specific overrides for optimal output quality
  # DYNAMIC TOKEN ALLOCATION: Uses percentageAllocation to automatically adjust to any LLM model
  # When a new model is added, phases automatically scale to that model's maxOutputTokens
  # Example: If new model has 128K output, SOLUTIONING gets 100% = 128K, SPEC gets 75% = 96K, etc.
  #
  # Configuration supports:
  # 1. percentageAllocation: Percentage of model's max output tokens to allocate
  # 2. minTokens: Minimum tokens guaranteed (safety floor)
  # 3. maxTokensCap: Maximum tokens allowed (safety ceiling)
  #
  # Set both percentageAllocation AND legacy max_tokens during migration period.
  # The system will use percentageAllocation (new) and ignore max_tokens (legacy) when both present.
  phase_overrides:
    ANALYSIS:
      temperature: 0.7
      percentageAllocation: 50      # 50% of model's max output
      minTokens: 8000              # Minimum 8K tokens for quality analysis
      # Legacy fallback (ignored if percentageAllocation present):
      max_tokens: 32000

    STACK_SELECTION:
      temperature: 0.3
      percentageAllocation: 25      # 25% of model's max output
      minTokens: 4000              # Minimum 4K tokens
      # Legacy fallback:
      max_tokens: 16000

    SPEC:
      temperature: 0.3
      percentageAllocation: 75      # 75% of model's max output (comprehensive specs)
      minTokens: 12000             # Minimum 12K tokens for detailed specs
      # Legacy fallback:
      max_tokens: 48000

    DEPENDENCIES:
      temperature: 0.2
      percentageAllocation: 37      # 37% of model's max output
      minTokens: 6000              # Minimum 6K tokens
      # Legacy fallback:
      max_tokens: 24000

    SOLUTIONING:
      temperature: 0.4
      percentageAllocation: 100     # 100% of model's max output (uses full capability)
      minTokens: 16000             # Minimum 16K tokens for detailed architecture
      # Legacy fallback:
      max_tokens: 64000

    VALIDATE:
      temperature: 0.3
      percentageAllocation: 50      # 50% of model's max output
      minTokens: 8000              # Minimum 8K tokens
      # Legacy fallback:
      max_tokens: 32000

    DONE:
      temperature: 0.3
      percentageAllocation: 50      # 50% of model's max output
      minTokens: 8000              # Minimum 8K tokens
      # Legacy fallback:
      max_tokens: 32000
  
  # Rate limiting and cost management
  rate_limit:
    requests_per_minute: 60
    tokens_per_hour: 100000
    
  cost_management:
    max_cost_per_project: 50.0  # USD
    token_cost_per_million: 0.5

# Project defaults
project_defaults:
  current_phase: "ANALYSIS"
  phases_completed: []
  stack_choice: null
  stack_approved: false
  dependencies_approved: false
  artifact_versions: {}
  zip_ready: false
