name: Spec Validation

on:
  push:
    branches: ["spec/**"]
    paths: ["specs/**", "orchestrator_spec.yml"]
  pull_request:
    paths: ["specs/**", "orchestrator_spec.yml"]

env:
  NODE_VERSION: "20"

jobs:
  validate_specs:
    name: Validate Phase Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate orchestrator spec
        run: npm run spec:validate

      - name: Check Constitutional Compliance
        run: npm run spec:constitutional-check
        continue-on-error: false

      - name: Generate validation badge
        run: npm run spec:badge-gen

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.json
          retention-days: 7

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let reportContent;
            try {
              reportContent = fs.readFileSync('validation-report.json', 'utf8');
            } catch (e) {
              console.log('No validation report found');
              return;
            }
            
            const report = JSON.parse(reportContent);
            const summary = report.summary || {};
            
            const emoji = summary.overallStatus === 'pass' ? 'âœ…' : 
                          summary.overallStatus === 'warning' ? 'âš ï¸' : 'âŒ';
            
            const body = `## ðŸ“‹ Spec Validation Results

| Metric | Value |
|--------|-------|
| **Status** | ${emoji} ${summary.overallStatus?.toUpperCase() || 'N/A'} |
| **Total Checks** | ${summary.totalChecks || 0} |
| **Passed** | ${summary.passed || 0} |
| **Failed** | ${summary.failed || 0} |
| **Warnings** | ${summary.warnings || 0} |

### Detailed Results
${report.checks?.map(check => {
  const checkEmoji = check.status === 'pass' ? 'âœ…' : check.status === 'fail' ? 'âŒ' : 'âš ï¸';
  return `- ${checkEmoji} **${check.name}**: ${check.details || check.status}`;
}).join('\n') || 'No checks available'}

---
*Generated by Spec-Driven Platform CI/CD*
`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              body: body
            });

  constitutional_check:
    name: Constitutional Articles Check
    runs-on: ubuntu-latest
    needs: validate_specs
    if: always()
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Verify constitutional compliance
        run: |
          echo "Checking Constitutional Articles compliance..."
          npm run spec:constitutional-check
        continue-on-error: false

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: constitutional-compliance-report
          path: constitutional-report.json
          retention-days: 7

  badge_generation:
    name: Generate Validation Badge
    runs-on: ubuntu-latest
    needs: [validate_specs, constitutional_check]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate SVG badge
        run: |
          # Read validation result
          if [ -f "artifacts/validation-report/validation-report.json" ]; then
            RESULT=$(cat artifacts/validation-report/validation-report.json | grep -o '"overallStatus":"[^"]*"' | cut -d'"' -f4)
          else
            RESULT="unknown"
          fi
          
          # Generate badge
          case $RESULT in
            pass) COLOR="green" ;;
            fail) COLOR="red" ;;
            warning) COLOR="yellow" ;;
            *) COLOR="gray" ;;
          esac
          
          echo "{\"schemaVersion\": 1, \"label\": \"spec\", \"message\": \"$RESULT\", \"color\": \"$COLOR\"}" > badge.json
          cat badge.json

      - name: Upload badge
        uses: actions/upload-artifact@v4
        with:
          name: spec-validation-badge
          path: badge.json
          retention-days: 30

  notify_on_failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate_specs, constitutional_check, badge_generation]
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "::warning::Spec validation failed. Please review the validation report."
        continue-on-error: true
